<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Nautics - Gestión de Flota</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
    body { margin: 0; padding: 0; }
    :root {
        --color-nautics-primary-blue: #0D47A1;
        --color-nautics-secondary-pink: #FF4081;
        --color-nautics-dark: #0A1C2C;
        --color-nautics-mid: #1E3A59;
        --color-nautics-light: #B0D3F5;
        --color-nautics-accent-pink: #F8C8DC;
        --color-nautics-text: #F0F8FF;
        --color-nautics-chat-bg: #2A3A4A;
    }
    .bg-nautics-dark { background-color: var(--color-nautics-dark); }
    .bg-nautics-mid { background-color: var(--color-nautics-mid); }
    .bg-nautics-accent { background-color: var(--color-nautics-accent); } 
    .bg-nautics-accent-pink { background-color: var(--color-nautics-accent-pink); } 
    .text-nautics-light { color: var(--color-nautics-light); }
    .text-nautics-text { color: var(--color-nautics-text); }
    .text-nautics-primary-blue { color: var(--color-nautics-primary-blue); }
    .text-nautics-secondary-pink { color: var(--color-nautics-secondary-pink); }
    .border-nautics-mid { border-color: var(--color-nautics-mid); }
    .border-nautics-primary-blue { border-color: var(--color-nautics-primary-blue); }
    .border-nautics-secondary-pink { border-color: var(--color-nautics-secondary-pink); }
    body { 
        font-family: 'Inter', sans-serif; 
        background: url('Fondo.png') center top no-repeat;
        background-size: cover; 
        background-attachment: fixed; 
        color: var(--color-nautics-text); 
    }
    .bg-overlay { background-color: rgba(0, 0, 0, 0.75); } 
    .btn { 
        background-color: var(--color-nautics-primary-blue); 
        color: white; 
        padding: 0.5rem 1rem; 
        border-radius: 0.375rem; 
        font-weight: 600; 
        cursor: pointer; 
        transition: background-color 0.3s; 
        margin-right: 0.5rem; 
        border: 1px solid var(--color-nautics-light);
    }
    .btn:hover { background-color: var(--color-nautics-mid); }
    .btn:disabled { background-color: #3b0764; cursor: not-allowed; }
    
    #anuncio-panel-lateral { 
        position: fixed; 
        top: 100px; 
        left: 20px; 
        width: 320px; 
        max-height: 80vh;
        background-color: rgba(10, 28, 44, 0.9); 
        backdrop-filter: blur(8px);
        border: 1px solid var(--color-nautics-primary-blue);
        border-radius: 10px;
        padding: 1.5rem;
        z-index: 9998; 
        font-weight: bold; 
        box-shadow: 4px 4px 20px rgba(0,0,0,0.6); 
        transform: translateX(-120%);
        transition: transform 0.4s ease-in-out;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }
    #anuncio-panel-lateral.visible {
        transform: translateX(0);
    }
    #anuncio-cerrar { font-size: 1.5rem; cursor: pointer; background: none; border: none; color: white; position: absolute; top: 10px; right: 15px; }
    .votacion-btn { 
        background-color: var(--color-nautics-mid); 
        border: 1px solid var(--color-nautics-light); 
        border-radius: 8px; padding: 0.5rem; margin-top: 0.5rem; width: 48%; font-size: 1rem; transition: background-color 0.2s; 
    }
    .votacion-btn:hover:not(:disabled) { background-color: var(--color-nautics-primary-blue); }
    .votacion-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: var(--color-nautics-dark); }

    .producto-card img, .producto-card svg { 
        border-radius: 0.5rem; 
        height: 96px; 
        width: 96px; 
        object-fit: cover;
        margin: auto; 
    }
    #contenido { min-height: 60vh; }
    .panel-image { width: 100%; height: 100%; max-height: 200px; object-fit: contain; }
    .status-indicator { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .status-indicator:hover { transform: scale(1.1); }
    .status-indicator.active { box-shadow: 0 0 0 3px white; }
    .barco-img { width: 100%; height: 120px; object-fit: cover; border-radius: 0.375rem; } 
    .inventory-upload-box { width: 100%; height: 180px; background-color: rgba(0,0,0,0.2); border: 2px dashed var(--color-nautics-primary-blue); border-radius: 0.5rem; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; overflow: hidden; }
    .inventory-upload-box:hover { background-color: rgba(0,0,0,0.4); }
    .inventory-upload-box img { width: 100%; height: 100%; object-fit: cover; }
    .inventory-upload-box .remove-btn { position: absolute; top: 5px; right: 5px; background-color: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-weight: bold; line-height: 24px; text-align: center; cursor: pointer; display: none; }
    .inventory-upload-box.has-image .remove-btn { display: block; }
    .inventory-upload-box.has-image .placeholder-text { display: none; }
    #chatbot-button-wrapper { position: fixed; bottom: 40px; right: 40px; z-index: 1000; }
    #chatbot-button { width: 140px; height: 140px; border-radius: 50%; overflow: hidden; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); cursor: pointer; transition: transform 0.3s ease; animation: pulse-small 2s infinite; }
    #chatbot-button:hover { transform: scale(1.05); }
    #chatbot-button img { width: 100%; height: 100%; object-fit: contain; z-index: 1001; position: relative; }
    @keyframes pulse-small{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
    #chatbot-bubble{position:absolute;bottom:150px;right:0;background-color:var(--color-nautics-secondary-pink);color:#fff;padding:12px 18px;border-radius:20px;border-bottom-right-radius:2px;box-shadow:0 4px 8px rgba(0,0,0,.3);white-space:nowrap;font-weight:600;cursor:pointer;opacity:0;visibility:hidden;transform:translateY(20px);transition:opacity .4s ease,transform .4s ease}#chatbot-bubble.visible{opacity:1;visibility:visible;transform:translateY(0)}
    #chatbot-container{position:fixed;bottom:40px;right:40px;width:450px;height:600px;background-color:var(--color-nautics-dark);border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.5);display:none;flex-direction:column;z-index:999;overflow:hidden;border:2px solid var(--color-nautics-primary-blue);box-sizing:border-box}#chatbot-header{background-color:var(--color-nautics-primary-blue);color:#fff;padding:10px 15px;font-weight:700;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;box-sizing:border-box;width:100%}#chatbot-close,#chatbot-minimize{background:0 0;border:none;color:#fff;font-size:1.2em;cursor:pointer;margin-left:10px;padding:0;line-height:1}
    #chatbot-messages{flex-grow:1;padding:15px;overflow-y:auto;background-color:var(--color-nautics-chat-bg);background-image: url('Jack_Sparrow.png'); background-repeat: no-repeat; background-position: bottom 10px right 10px; background-size: 120px; background-blend-mode: luminosity; opacity: 0.8;}
    .chat-message{margin-bottom:10px;padding:8px 12px;border-radius:15px;max-width:80%;line-height:1.4;word-wrap:break-word;box-sizing:border-box; position: relative; z-index: 2;}.user-message{background-color:var(--color-nautics-secondary-pink);align-self:flex-end;border-bottom-right-radius:2px}.bot-message{background-color:var(--color-nautics-mid);align-self:flex-start;border-bottom-left-radius:2px}#chatbot-input-container{padding:10px 15px;display:flex;align-items:center;gap:10px;background-color:var(--color-nautics-dark);flex-shrink:0;box-sizing:border-box;width:100%; position: relative; z-index: 1002;}
    #chatbot-input{flex-grow:1;padding:10px;border-radius:20px;border:1px solid var(--color-nautics-primary-blue);background-color:#333355;color:#fff;box-sizing:border-box;min-width:0}
    .chatbot-action-btn{background-color:transparent;color:#fff;border:none;border-radius:50%;width:40px;height:40px;display:flex;justify-content:center;align-items:center;cursor:pointer;font-size:1.5em;transition:background-color .3s;flex-shrink:0}.chatbot-action-btn:hover{background-color:var(--color-nautics-primary-blue)}
    #image-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:2000}#overlay-image{max-width:90%;max-height:90%;object-fit:contain;cursor:pointer}#overlay-close-btn{position:absolute;top:20px;right:35px;font-size:45px;color:#fff;cursor:pointer;line-height:1}
    #chatbot-image-previews { display: flex; gap: 8px; padding: 0 15px 10px 15px; flex-wrap: wrap; background-color: var(--color-nautics-dark);}
    .chat-preview-item { position: relative; }
    .chat-preview-img { height: 50px; width: 50px; object-fit: cover; border-radius: 5px; }
    .chat-preview-remove { position: absolute; top: -5px; right: -5px; background: #c44; color: white; border-radius: 50%; width: 18px; height: 18px; border: none; cursor: pointer; font-size: 12px; line-height: 18px; text-align: center; font-weight: bold; }
    .chat-preview-item.has-image .remove-btn { display: block; }
    .chat-message img { max-width: 100%; border-radius: 10px; margin-top: 5px; }

    .prices-table th, .prices-table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--color-nautics-mid);
        text-align: left;
    }
    .prices-table th {
        background-color: var(--color-nautics-dark);
        font-weight: bold;
    }
    .prices-table tr:last-child td {
        border-bottom: none;
    }
</style>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, getDoc, query, orderBy, addDoc, serverTimestamp, where, writeBatch, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; 
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyA7pg9vtqsPNGu3EGEEZ8hGnQJTkTBVjss",
      authDomain: "nautics-78bf2.firebaseapp.com",
      projectId: "nautics-78bf2",
      storageBucket: "nautics-78bf2.firebasestorage.app",
      messagingSenderId: "791025583667",
      appId: "1:791025583667:web:09c6171074ce448b94c546",
      measurementId: "G-2ZJ4RBYD3N"
    };
    
    const firebaseApp = initializeApp(firebaseConfig);
    window.db = getFirestore(firebaseApp);
    window.storage = getStorage(firebaseApp);
    
    window.Firebase = {
        collection, getDocs, doc, setDoc, updateDoc, deleteDoc, getDoc, query, orderBy, addDoc, serverTimestamp, where, writeBatch, onSnapshot, arrayUnion
    };
</script>
</head>
<body class="text-nautics-text">
<div id="anuncio-panel-lateral"></div>
<audio id="alarm-sound" src="alarm.mp3" preload="auto"></audio>
<audio id="notification-sound" src="notification.mp3" preload="auto"></audio>

<div class="bg-overlay min-h-screen">
<nav class="bg-nautics-dark text-white px-6 py-4 flex justify-between items-center">
<h1 class="text-xl font-bold cursor-pointer" onclick="VanillaApp.mostrarInicio()">Nautics</h1>
<ul class="flex space-x-6 text-sm">
<li><a class="hover:underline" href="#" onclick="VanillaApp.mostrarInicio()">Inicio</a></li>
<li><a class="hover:underline" href="#" onclick="VanillaApp.irAPanelEmpleado()">Empleados</a></li>
<li><a class="hover:underline" href="#" onclick="VanillaApp.mostrarPanelProductos()">Productos</a></li>
<li><a class="hover:underline" href="#" onclick="VanillaApp.mostrarPanelBarcos()">Barcos</a></li>
</ul>
</nav>
<main class="p-8" id="contenido"></main>
</div>

<div id="image-overlay"><span id="overlay-close-btn">&times;</span><img id="overlay-image" src="" alt="Imagen ampliada"></div>
<div id="chatbot-button-wrapper"><div id="chatbot-bubble">Si necesitas alguna cosa, dime y te ayudo</div><div id="chatbot-button"><img alt="Asistente de Chat" src="Jack_Sparrow.png"/></div></div>
<div id="chatbot-container">
    <div id="chatbot-header">
        <span>Asistente Nautics</span>
        <div><button id="chatbot-minimize" title="Minimizar">_</button><button id="chatbot-close" title="Cerrar">X</button></div>
    </div>
    <div id="chatbot-messages"></div>
    <div id="chatbot-image-previews"></div>
    <div id="chatbot-input-container">
        <label for="chatbot-file-input" class="chatbot-action-btn" title="Subir imagen">+</label>
        <input type="file" id="chatbot-file-input" accept="image/*" style="display: none;" />
        <input id="chatbot-input" placeholder="Escribe tu mensaje..." type="text"/>
        <button id="chatbot-send" class="chatbot-action-btn">➤</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const VanillaApp = { 
        state: {
            productos: [ 
                { id: 'pescanova', nombre: 'Pescanova', imagen: 'Pescanova.png', precio: 50 }, 
                { id: 'cana', nombre: 'Caña de Pescar', imagen: 'Caña.png', precio: 750 }, 
                { id: 'cebo', nombre: 'Cebo Marino', imagen: 'cebo.png', precio: 1000 }, 
                { id: 'yonkayate', nombre: 'WonkaYate', imagen: 'WonkaYate.png', precio: 50 } 
            ],
            datosBarcosBase: [ 
                { id: 1, nombre: 'La Perla Negra', imagen: 'Jack_Sparrow.png', reservas: [] }, 
                { id: 2, nombre: 'El Jet Max', imagen: 'JetMax.png', reservas: [] },
                { id: 3, nombre: 'El Long Fin', imagen: 'LongFin.png', reservas: [] },
                { id: 4, nombre: 'El Marquis', imagen: 'Marquis.png', reservas: [] },
                { id: 5, nombre: 'La Avisa', imagen: 'Avisa.png', reservas: [] },
                { id: 6, nombre: 'El Speeder', imagen: 'Speeder.png', reservas: [] },
                { id: 7, nombre: 'El Squalo', imagen: 'Squalo.png', reservas: [] },
                { id: 8, nombre: 'El Submarino', imagen: 'Submarino.png', reservas: [] },
                { id: 9, nombre: 'El Sun Trap', imagen: 'SunTrap.png', reservas: [] },
                { id: 10, nombre: 'El Toro', imagen: 'Toro.png', reservas: [] },
                { id: 11, nombre: 'El Tropic', imagen: 'Tropic.png', reservas: [] },
                { id: 12, nombre: 'La Dhingy', imagen: 'Dhingy.png', reservas: [] }, 
            ],
            empleados: [], fichajes: {}, ventas: {}, barcos: [], 
            inventarioLog: [], libroNegro: [], listaNegra: [], 
            clientesVentas: {},
            timers: { fichaje: null, barcos: null, dashboard: null, localOpen: null }, 
            inventoryFiles: [null, null, null],
            chatFiles: [],
            ultimoAnuncioMostrado: null,
            unsubscribeBarcos: null, 
        },

        stopAllTimers() { Object.keys(this.state.timers).forEach(t => { if(this.state.timers[t]) clearInterval(this.state.timers[t]); this.state.timers[t] = null; }); },
        stopPanelTimers() { if(this.state.timers.fichaje) clearInterval(this.state.timers.fichaje); if(this.state.timers.barcos) clearInterval(this.state.timers.barcos); this.state.timers.fichaje = null; this.state.timers.barcos = null;}, 
        startClockInTimer(horaInicio, baseHoy, baseSemana, baseTotal) { this.stopPanelTimers(); this.state.timers.fichaje = setInterval(() => { const tiempoSesionElem = document.getElementById('tiempoSesion'); const tiempoHoyElem = document.getElementById('tiempoHoy'); const tiempoSemanaElem = document.getElementById('tiempoSemana'); const tiempoTotalElem = document.getElementById('tiempoTotal'); if (tiempoSesionElem && tiempoHoyElem && tiempoSemanaElem && tiempoTotalElem) { const tiempoSesion = Date.now() - horaInicio; tiempoHoyElem.textContent = this.formatearTiempo(baseHoy + tiempoSesion); tiempoSemanaElem.textContent = this.formatearTiempo(baseSemana + tiempoSesion); tiempoTotalElem.textContent = this.formatearTiempo(baseTotal + tiempoSesion); tiempoSesionElem.textContent = this.formatearTiempo(tiempoSesion); } }, 1000); },
        startBoatsTimer() { 
            this.state.timers.barcos = setInterval(() => { 
                this.state.barcos.forEach(boat => { 
                    const ahora = Date.now();
                    const reservaActual = boat.reservas ? boat.reservas.find(res => ahora >= (res.inicio.toMillis ? res.inicio.toMillis() : res.inicio) && ahora < (res.fin.toMillis ? res.fin.toMillis() : res.fin)) : null;
                    const tiempoRestanteElem = document.getElementById(`timer-boat-${boat.id}`); 
                    if (tiempoRestanteElem) {
                        if (reservaActual) {
                            const restante = (reservaActual.fin.toMillis ? reservaActual.fin.toMillis() : reservaActual.fin) - ahora;
                            if (restante > 0) {
                                tiempoRestanteElem.textContent = this.formatearTiempo(restante);
                            } else {
                                tiempoRestanteElem.textContent = "¡TIEMPO AGOTADO!";
                                tiempoRestanteElem.classList.add('text-red-500');
                                if (!reservaActual.alarmaSonada) {
                                    document.getElementById('alarm-sound').play().catch(e => console.warn("Interacción del usuario necesaria para reproducir audio."));
                                    reservaActual.alarmaSonada = true;
                                }
                            }
                        } else {
                            tiempoRestanteElem.textContent = "--:--:--";
                            tiempoRestanteElem.classList.remove('text-red-500');
                        }
                    }
                });
            }, 1000);
        },
        startDashboardTimer() { this.stopAllTimers(); this.actualizarDashboard(); this.state.timers.dashboard = setInterval(() => this.actualizarDashboard(), 5000); },
        startLocalOpenTimer(horaInicio) { if (this.state.timers.localOpen) clearInterval(this.state.timers.localOpen); this.state.timers.localOpen = setInterval(() => { const timerElem = document.getElementById('tiempoAbiertoLocal'); if(timerElem) { const tiempoAbierto = Date.now() - horaInicio; timerElem.textContent = this.formatearTiempo(tiempoAbierto); } }, 1000);},
        
        hashPassword(str) { let hash = 0; if (typeof str !== 'string' || str.length === 0) return "hash_0"; for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0; } return "hash_" + Math.abs(hash); },
        formatearTiempo(ms) { if (isNaN(ms) || ms < 0) ms = 0; const s = Math.floor(ms / 1000), h = String(Math.floor(s / 3600)).padStart(2, '0'), m = String(Math.floor((s % 3600) / 60)).padStart(2, '0'), sec = String(s % 60).padStart(2, '0'); return `${h}:${m}:${sec}`; },
        formatearTiempoHorasDecimal(ms) { if (isNaN(ms) || ms <= 0) return "0,0"; const horas = ms / (1000 * 60 * 60); return horas.toFixed(1).replace('.', ','); },
        getEstadoBarco(boat) { const now = Date.now(); if (!boat || !boat.reservas) return { estado: 'disponible', texto: 'Disponible', reservaActual: null }; const r = boat.reservas.find(res => now >= (res.inicio.toMillis ? res.inicio.toMillis() : res.inicio) && now < (res.fin.toMillis ? res.fin.toMillis() : res.fin)); return r ? { estado: 'ocupada', texto: 'Ocupado', reservaActual: r } : { estado: 'disponible', texto: 'Disponible', reservaActual: null }; }, 
        getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); },
        estaDeAusencia(empleado) {
            if (!empleado || !empleado.ausencias || !Array.isArray(empleado.ausencias)) return false;
            const ahora = Date.now();
            return empleado.ausencias.some(periodo => 
                periodo && typeof periodo.inicio === 'number' && typeof periodo.fin === 'number' &&
                ahora >= periodo.inicio && ahora <= periodo.fin
            );
        },

        async cargarTodosLosEmpleados() { 
            try { 
                const snapshot = await Firebase.getDocs(Firebase.query(Firebase.collection(db, 'empleados'), Firebase.orderBy('nombre'))); 
                this.state.empleados = []; 
                snapshot.forEach(doc => this.state.empleados.push({ id: doc.id, ...doc.data() })); 
            } catch (e) { console.error("Error cargando empleados:", e); } 
        },
        async cargarTodosLosFichajes() { 
            try { 
                const snapshot = await Firebase.getDocs(Firebase.collection(db, 'fichajes')); 
                let fichajesData = {}; 
                snapshot.forEach(doc => { fichajesData[doc.id] = doc.data(); }); 
                this.state.fichajes = fichajesData; 
            } catch (e) { console.error("Error cargando fichajes:", e); } 
        },
        async cargarTodasLasVentas() { 
            try { 
                const snapshot = await Firebase.getDocs(Firebase.collection(db, 'ventas')); 
                this.state.ventas = {}; 
                snapshot.forEach(doc => { this.state.ventas[doc.id] = doc.data(); }); 
                this.state.productos.forEach(p => { for(const emp in this.state.ventas) { if(!this.state.ventas[emp].productos) this.state.ventas[emp].productos = {}; if(!this.state.ventas[emp].productos[p.id]) this.state.ventas[emp].productos[p.id] = { hoy: 0, total: 0 }; } }); 
            } catch (e) { console.error("Error cargando ventas:", e); } 
        },
        async cargarInventarioLog() { 
            try { 
                const q = Firebase.query(Firebase.collection(db, 'inventario_log'), Firebase.orderBy('timestamp', 'desc')); 
                const snapshot = await Firebase.getDocs(q); 
                this.state.inventarioLog = []; 
                snapshot.forEach(doc => this.state.inventarioLog.push(doc.data())); 
            } catch (e) { console.error("Error cargando log de inventario:", e); } 
        },
        async cargarLibroNegro() { 
            try { 
                const snapshot = await Firebase.getDocs(Firebase.collection(db, 'libroNegro')); 
                this.state.libroNegro = []; 
                snapshot.forEach(doc => this.state.libroNegro.push({docId: doc.id, ...doc.data()})); 
            } catch (e) { console.error("Error cargando Libro Negro:", e); } 
        },
        async cargarListaNegra() { 
            try { 
                const snapshot = await Firebase.getDocs(Firebase.collection(db, 'listaNegra')); 
                this.state.listaNegra = []; 
                snapshot.forEach(doc => this.state.listaNegra.push({docId: doc.id, ...doc.data()})); 
            } catch (e) { console.error("Error cargando Lista Negra:", e); } 
        },
        
        async cargarClienteVentas() {
            try {
                const snapshot = await Firebase.getDocs(Firebase.collection(db, 'clientesVentas'));
                this.state.clientesVentas = {};
                snapshot.forEach(doc => {
                    this.state.clientesVentas[doc.id] = doc.data();
                });
            } catch (e) {
                console.error("Error cargando ventas de clientes:", e);
            }
        },

        async irAPanelEmpleado() { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (currentUser) { 
                await this.mostrarPanelEmpleados(currentUser); 
            } else { 
                this.mostrarLoginVIP(); 
            }
        },
        mostrarInicio() { 
            this.stopAllTimers(); 
            if (typeof this.state.unsubscribeBarcos === 'function') { this.state.unsubscribeBarcos(); } 
            document.getElementById('contenido').innerHTML = `
                <div class="p-4 md:p-8 max-w-7xl mx-auto rounded-lg bg-nautics-dark bg-opacity-90 shadow-lg border border-nautics-primary-blue">
                    <header class="mb-8 text-center">
                        <h1 class="text-5xl font-extrabold text-white drop-shadow-lg mb-2">¡Ahoy, Navegante! Bienvenido a Nautics</h1>
                        <p class="text-nautics-light text-lg">Donde la brújula del lujo te guía a la aventura.</p>
                    </header>
                    
                    <section class="mb-12">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div class="flex justify-center md:order-1">
                                <img src="Jackcompleto.png" alt="Capitán Jack Sparrow" class="rounded-lg shadow-2xl w-full h-auto object-cover max-w-md border-2 border-nautics-secondary-pink" />
                            </div>
                            <div class="space-y-6 md:order-2">
                                <div class="bg-nautics-mid bg-opacity-50 p-4 rounded-lg border border-nautics-primary-blue">
                                    <h2 class="text-2xl font-bold text-white mb-2">El Comienzo de la Leyenda en Nautics</h2>
                                    <p class="text-nautics-light">Se dice que tras innumerables escapes y búsquedas de tesoros, el mismísimo Capitán Jack Sparrow sintió el llamado de un nuevo horizonte. Fue en las costas de Murcia donde sus ojos avistaron Nautics, un imperio de lujo y aventura en el mar. Fascinado por el espíritu de Nautics y la audacia de Tito Giovanni y su flota, Jack decidió que este sería su próximo gran "negocio". Con su carisma inconfundible y su sombrero desafiante, se unió a la tripulación, no para robar, sino para enriquecerla con su espíritu indomable y su astucia legendaria.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="mb-12">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div class="space-y-6 md:order-1">
                                <div class="bg-nautics-mid bg-opacity-50 p-4 rounded-lg border border-nautics-primary-blue">
                                    <h2 class="text-2xl font-bold text-white mb-2">Un Nuevo Timón, Un Nuevo Destino</h2>
                                    <p class="text-nautics-light">La influencia de Jack no tardó en notarse. Inspirado por la elegancia de Tito y la eficiencia de Capitana Marta, Jack "invirtió" sus peculiares ganancias en innovar la flota. Se rumorea que el diseño del timón principal de Nautics guarda secretos de sus mapas más preciados, y que cada barco zarpa con una pizca de su espíritu aventurero. El timón, con su madera pulida y su tacto firme, guía a la flota hacia destinos que solo los verdaderos capitanes conocen, siempre con la promesa de una travesía inolvidable.</p>
                                </div>
                                <div class="bg-nautics-mid bg-opacity-50 p-4 rounded-lg border border-nautics-primary-blue">
                                    <h2 class="text-2xl font-bold text-white mb-2">El Cofre de las Oportunidades</h2>
                                    <p class="text-nautics-light">Incluso un pirata legendario sabe que la logística es clave para un imperio. El inventario de Nautics, repleto de provisiones exóticas y equipos de alta tecnología, está custodiado por un cofre ancestral, un "obsequio" del propio Jack. Cada producto, desde un zumo tropical hasta un submarino de lujo, es parte de un tesoro que ahora está a tu alcance, gestionado con la astucia que solo un pirata y un empresario como Tito Giovanni pueden ofrecer.</p>
                                </div>
                            </div>
                            <div class="flex justify-center md:order-2">
                                <img src="jacktesoro.png" alt="Jack Sparrow con Tesoro" class="rounded-lg shadow-2xl w-full h-auto object-contain max-w-md border-2 border-nautics-secondary-pink" />
                            </div>
                        </div>
                    </section>
                    
                    <div class="mt-10 flex justify-center gap-4 flex-wrap">
                        <button onclick="VanillaApp.mostrarLoginVIP()" class="btn text-lg px-6 py-3">Acceso a la Tripulación</button>
                        <button onclick="VanillaApp.mostrarLoginAdmin()" class="btn text-lg px-6 py-3" style="background-color: var(--color-nautics-secondary-pink);">Jefes de Flota</button>
                    </div>
                </div>`; 
            this.ajustarPosicionChatbot(true); 
        },
        mostrarLoginVIP() {
            this.stopAllTimers();
            if (typeof this.state.unsubscribeBarcos === 'function') { this.state.unsubscribeBarcos(); }
            document.getElementById('contenido').innerHTML = `
                <div class="max-w-md mx-auto bg-nautics-dark bg-opacity-70 p-8 rounded-lg shadow-lg border-2 border-nautics-mid">
                    <h2 class="text-2xl font-bold mb-4 text-center text-nautics-text">Acceso de la Tripulación</h2>
                    <div class="mb-4">
                        <label class="block mb-2 text-nautics-light">Nombre completo:</label>
                        <input id="nombreInput" type="text" class="w-full px-3 py-2 text-gray-900 rounded bg-nautics-light" placeholder="nombre y apellido en minúsculas" autocomplete="username" />
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2 text-nautics-light">Contraseña:</label>
                        <input id="passInput" type="password" class="w-full px-3 py-2 text-gray-900 rounded bg-nautics-light" autocomplete="current-password" />
                    </div>
                    <div class="flex justify-between mt-6">
                        <button onclick="VanillaApp.verificarAccesoVIP()" class="btn">Embarcar</button>
                        <button onclick="VanillaApp.mostrarInicio()" class="btn" style="background-color:var(--color-nautics-mid);">Volver a Puerto</button>
                    </div>
                </div>`;
            document.getElementById('passInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.verificarAccesoVIP(); });
            this.ajustarPosicionChatbot(false);
        },
        mostrarLoginAdmin() {
            this.stopAllTimers();
            if (typeof this.state.unsubscribeBarcos === 'function') { this.state.unsubscribeBarcos(); }
            document.getElementById('contenido').innerHTML = `
                <div class="max-w-md mx-auto bg-nautics-dark bg-opacity-70 p-8 rounded-lg shadow-lg border-2 border-nautics-secondary-pink">
                    <h2 class="text-3xl font-bold mb-4 text-center text-nautics-text">Acceso Privado - Jefes de Flota</h2>
                    
                    <div class="mb-4">
                        <label class="block mb-2 text-nautics-light">Contraseña de Jefes:</label>
                        <input id="adminPassInput" type="password" class="w-full px-3 py-2 text-gray-900 rounded bg-nautics-light" autocomplete="current-password" />
                    </div>
                    <div class="flex justify-between mt-6">
                        <button onclick="VanillaApp.verificarAccesoAdmin()" class="btn">Izad la Bandera</button>
                        <button onclick="VanillaApp.mostrarInicio()" class="btn" style="background-color:var(--color-nautics-mid);">Volver a Puerto</button>
                    </div>
                </div>`;
            document.getElementById('adminPassInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.verificarAccesoAdmin(); });
            this.ajustarPosicionChatbot(false);
        },
        
        crearTarjetaProducto(producto, esPanelVenta = false, nombreEmpleado = '') {
            let totalVentasHoy = 0, totalVentasHist = 0;
            const productoPrecio = producto.precio !== undefined ? producto.precio : 50; 

            if (this.state.ventas[nombreEmpleado] && this.state.ventas[nombreEmpleado].productos && this.state.ventas[nombreEmpleado].productos[producto.id]) {
                totalVentasHoy = this.state.ventas[nombreEmpleado].productos[producto.id].hoy || 0;
                totalVentasHist = this.state.ventas[nombreEmpleado].productos[producto.id].total || 0;
            }
            const desc = `<p class="text-xs mt-1" id="desc-${producto.id}">Hoy: ${totalVentasHoy} | Total: ${totalVentasHist}</p>`;
            const inputVentasHTML = esPanelVenta 
                ? `<div class="mt-2">
                     <div class="flex items-center justify-center gap-2">
                       <button onclick="VanillaApp.modificarVenta('${producto.id}', '${nombreEmpleado}', -1)" class="btn text-lg py-1 px-3">-</button>
                       <span class="font-bold text-lg w-8 text-center" id="ventas-hoy-${producto.id}">${totalVentasHoy}</span>
                       <button onclick="VanillaApp.modificarVenta('${producto.id}', '${nombreEmpleado}', 1)" class="btn text-lg py-1 px-3">+</button>
                     </div>
                     ${desc}
                   </div>`
                : `<p class="text-nautics-light text-lg font-bold mt-2">$${productoPrecio}</p>`; 
            const imagenHTML = producto.imagen ? `<img src="${producto.imagen}" alt="${producto.nombre}" class="mx-auto mb-2 w-24 h-24 object-cover rounded" onerror="this.src='placeholder.png'"/>` : '';
            return `<div class="producto-card bg-nautics-mid rounded-lg p-2 text-center shadow-md flex flex-col justify-between text-sm"><div>${imagenHTML}<h3 class="text-white font-semibold leading-tight uppercase">${producto.nombre}</h3></div><div>${inputVentasHTML}</div></div>`;
        },

        mostrarPanelProductos() { 
            this.stopAllTimers(); 
            if (typeof this.state.unsubscribeBarcos === 'function') { this.state.unsubscribeBarcos(); } 
            this.ajustarPosicionChatbot(false); 
            
            const productosBaseHTML = this.state.productos.map(p => this.crearTarjetaProducto(p, false)).join(''); 
            
            const categoriaBajaHTML = `
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="Dhingy.png" alt="Dhingy" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">Dhingy</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $1000 | Paseo: $1100</p></div>
                </div>
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="SunTrap.png" alt="El Sun Trap" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">El Sun Trap</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $1000 | Paseo: $1100</p></div>
                </div>
            `;
            const categoriaEstandarHTML = `
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="Squalo.png" alt="Squalo" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">Squalo</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $1430 | Paseo: $1570</p></div>
                </div>
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="Tropic.png" alt="El Tropic" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">El Tropic</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $1430 | Paseo: $1570</p></div>
                </div>
            `;
            const categoriaMediaHTML = `
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="JetMax.png" alt="El JetMax" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">El JetMax</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $1860 | Paseo: $2050</p></div>
                </div>
            `;
            const categoriaGoldHTML = `
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="pirate_ship_category.png" alt="Marquis" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">Marquis</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $2290 | Paseo: $2520</p></div>
                </div>
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="LongFin.png" alt="El Long Fin" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">El Long Fin</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $2290 | Paseo: $2520</p></div>
                </div>
                   <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="Speeder.png" alt="El Speeder" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">El Speeder</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $2290 | Paseo: $2520</p></div>
                </div>
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="Toro.png" alt="El Toro" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">El Toro</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $2290 | Paseo: $2520</p></div>
                </div>
            `;
            const categoriaAventuraHTML = `
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="Avisa.png" alt="La Avisa" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">La Avisa</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $2720 | Paseo: $3000</p></div>
                </div>
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="Submarino.png" alt="El Submarino" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">El Submarino</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $2720 | Paseo: $3000</p></div>
                </div>
            `;
            const categoriaMotosAguaHTML = `
                <div class="producto-card bg-nautics-mid rounded-lg p-4 text-center shadow-md flex flex-col justify-between">
                    <div><img src="Moto_de_agua.png" alt="Moto de Agua" class="mx-auto mb-2 w-full h-24 object-cover rounded"/>
                    <h3 class="text-white font-semibold leading-tight mt-2 uppercase">Moto de Agua</h3></div>
                    <div><p class="text-nautics-light text-lg font-bold mt-2">Alquiler: $500 | Paseo: $500</p></div>
                </div>
            `;
            
            document.getElementById('contenido').innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-center uppercase">Provisiones y Servicios de Flota</h2>
                
                <h3 class="text-2xl font-semibold mb-4 border-t border-nautics-mid pt-6 uppercase">Precios Principales por Categoría</h3>
                <div class="overflow-x-auto mb-8 bg-nautics-mid rounded-lg shadow-lg">
                    <table class="w-full text-left text-nautics-text prices-table">
                        <thead class="bg-nautics-dark uppercase text-sm">
                            <tr>
                                <th class="p-3 text-nautics-light">Categorías</th>
                                <th class="p-3 text-nautics-light">Alquiler</th>
                                <th class="p-3 text-nautics-light">Paseo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-3">Categoría Baja</td>
                                <td class="p-3">$1000</td>
                                <td class="p-3">$1100</td>
                            </tr>
                            <tr>
                                <td class="p-3">Categoría Estándar</td>
                                <td class="p-3">$1430</td>
                                <td class="p-3">$1570</td>
                            </tr>
                            <tr>
                                <td class="p-3">Categoría Media</td>
                                <td class="p-3">$1860</td>
                                <td class="p-3">$2050</td>
                            </tr>
                            <tr>
                                <td class="p-3">Categoría Gold</td>
                                <td class="p-3">$2290</td>
                                <td class="p-3">$2520</td>
                            </tr>
                            <tr>
                                <td class="p-3">Categoría Aventura</td>
                                <td class="p-3">$2720</td>
                                <td class="p-3">$3000</td>
                            </tr>
                            <tr>
                                <td class="p-3">Motos de Agua</td>
                                <td class="p-3">$500</td>
                                <td class="p-3">$500</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-2xl font-semibold mb-4 border-t border-nautics-mid pt-6 uppercase">Equipamiento Básico (Productos Individuales)</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-6">${productosBaseHTML}</div>

                <h3 class="text-2xl font-semibold mb-4 border-t border-nautics-mid pt-6 mt-8 uppercase">Nuestra Flota por Categorías</h3>
                
                <h4 class="text-xl font-semibold mb-3 mt-6 text-nautics-primary-blue">Categoría Baja (Barcos Pequeños)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">${categoriaBajaHTML}</div>

                <h4 class="text-xl font-semibold mb-3 mt-6 text-nautics-primary-blue">Categoría Estándar (Barcos Medianos)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">${categoriaEstandarHTML}</div>

                <h4 class="text-xl font-semibold mb-3 mt-6 text-nautics-primary-blue">Categoría Media (Lanchas Rápidas)</h4>
                <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-1 gap-6">${categoriaMediaHTML}</div>

                <h4 class="text-xl font-semibold mb-3 mt-6 text-nautics-primary-blue">Categoría Gold (Yates de Lujo)</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-6">${categoriaGoldHTML}</div>

                <h4 class="text-xl font-semibold mb-3 mt-6 text-nautics-primary-blue">Categoría Aventura (Exploración y Submarinismo)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">${categoriaAventuraHTML}</div>

                <h4 class="text-xl font-semibold mb-3 mt-6 text-nautics-primary-blue">Motos de Agua</h4>
                <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-1 gap-6">${categoriaMotosAguaHTML}</div>

                <div class="text-center"><button onclick="VanillaApp.mostrarInicio()" class="btn mt-8">Volver al Inicio</button></div>`; 
        },
        async mostrarPanelBarcos() { 
            this.stopAllTimers(); 
            if (typeof this.state.unsubscribeBarcos === 'function') { this.state.unsubscribeBarcos(); } 
            
            let html = `<div class="max-w-7xl mx-auto text-center">
                            <h1 class="text-4xl font-bold mb-8">Nuestra Flota de Barcos</h1>
                            <p class="text-nautics-light mb-8 max-w-3xl mx-auto">Selecciona tu navío y prepárate para la aventura. Rellena el formulario para asegurar tu travesía en los siete mares.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">`; 
            
            this.state.barcos.forEach(boat => { 
                html += `
                <div class="bg-nautics-mid rounded-lg shadow-lg overflow-hidden flex flex-col border border-nautics-primary-blue">
                    <img src="${boat.imagen}" alt="${boat.nombre}" class="w-full h-64 object-cover" onerror="this.src='placeholder.png'; this.classList.add('p-4', 'bg-nautics-dark');">
                    <div class="p-6 flex-grow flex flex-col">
                        <h2 class="text-2xl font-bold mb-4 text-nautics-light">${boat.nombre}</h2>
                        <div class="flex-grow space-y-4">
                            <input type="text" id="cliente-boat-${boat.id}" placeholder="Nombre del Capitán (Alquilador)" class="w-full p-2 rounded bg-nautics-light text-gray-900 text-sm placeholder-gray-500">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="date" id="fecha-boat-${boat.id}" class="w-full p-2 rounded bg-nautics-light text-gray-900 text-sm">
                                <input type="time" id="hora-boat-${boat.id}" step="1800" class="w-full p-2 rounded bg-nautics-light text-gray-900 text-sm">
                            </div>
                            <select id="duracion-boat-${boat.id}" class="w-full p-2 rounded bg-nautics-light text-gray-900 text-sm">
                                <optgroup label="Paseo">
                                    <option value="30">Paseo (30 Minutos)</option>
                                    <option value="60">Paseo (60 Minutos)</option>
                                    <option value="90">Paseo (90 Minutos)</option>
                                </optgroup>
                                <optgroup label="Alquiler">
                                    <option value="45">Alquiler (45 Minutos)</option>
                                    <option value="90">Alquiler (90 Minutos)</option>
                                    <option value="135">Alquiler (135 Minutos)</option>
                                    <option value="180">Alquiler (180 Minutos)</option>
                                </optgroup>
                            </select>
                        </div>
                        <button class="btn w-full mt-6 py-3 text-lg" style="background-color: var(--color-nautics-secondary-pink);" onclick="VanillaApp.reservarBarco(${boat.id})">Confirmar Reserva</button>
                    </div>
                </div>`;
            }); 
            
            html += `</div><div class="text-center"><button onclick="VanillaApp.mostrarInicio()" class="btn mt-8">Volver al Inicio</button></div></div>`; 
            document.getElementById('contenido').innerHTML = html; 
            
            const hoy = new Date(); 
            const dosSemanas = new Date(); 
            dosSemanas.setDate(hoy.getDate() + 14);
            const minDate = hoy.toISOString().split('T')[0]; 
            const maxDate = dosSemanas.toISOString().split('T')[0]; 
            document.querySelectorAll('input[type="date"]').forEach(input => { input.min = minDate; input.max = maxDate; input.value = minDate; }); 
            this.ajustarPosicionChatbot(false);
        },
        
        async mostrarPanelEmpleados(nombre) {
            this.stopAllTimers();
            this.ajustarPosicionChatbot(false);
            await this.cargarTodosLosEmpleados(); 
            const empleadoData = this.state.empleados.find(emp => emp.id === nombre) || {};
            
            const datosFichaje = await this.gestionarReseteoDatos(nombre); await this.gestionarReseteoDatos(nombre, true);
            let tiempoHoy = datosFichaje.hoy || 0, tiempoSemana = datosFichaje.semana || 0, tiempoTotal = datosFichaje.total || 0;
            if (datosFichaje.fichado) { const t = Date.now() - datosFichaje.inicio; tiempoHoy += t; tiempoSemana += t; tiempoTotal += t; }
            
            const productosVentaHTML = this.state.productos.map(p => this.crearTarjetaProducto(p, true, nombre)).join('');
            let barcosHTML = this.state.barcos.map(boat => { 
                const estadoActual = this.getEstadoBarco(boat); 
                let controles = (estadoActual.estado === 'disponible') 
                    ? `<button class="btn text-sm py-2 w-full" onclick="VanillaApp.ocuparBarcoAhora(${boat.id}, '${nombre}', 30)">Alquilar (30 min)</button>`
                    : `<div class="font-mono text-xl mb-2" id="timer-boat-${boat.id}">--:--:--</div><div class="flex gap-2"><button class="btn text-xs py-1 flex-grow" onclick="VanillaApp.anadirTiempoBarco(${boat.id}, '${nombre}', 30)">+30 min</button><button class="btn text-xs py-1 flex-grow" style="background-color:#dc2626" onclick="VanillaApp.liberarBarco(${boat.id}, '${nombre}')">Liberar</button></div>`; 
                return `<div class="bg-nautics-mid p-4 rounded-lg text-center flex flex-col justify-between"><div><p class="font-bold text-lg">${boat.nombre}</p><p class="text-sm ${estadoActual.estado === 'ocupada' ? 'text-red-400' : 'text-green-400'} mb-2">${estadoActual.texto}</p></div><div>${controles}</div></div>`;
            }).join('');

            const botonConveniosHTML = `<button onclick="VanillaApp.mostrarPanelConvenios(${empleadoData.directiva || false})" class="btn text-xs py-1">Convenios Navales</button>`;
            const botonesAccionHTML = `<button onclick="VanillaApp.mostrarModalAusencias('${nombre}')" class="btn text-xs py-1">Permisos de Ausencia</button>${botonConveniosHTML}<button onclick="VanillaApp.mostrarPanelInventario()" class="btn text-xs py-1">Inventario de Flota</button><button onclick="VanillaApp.mostrarListaNegraPublica()" class="btn text-xs py-1">Ver Piratas Vetados</button><button class="btn" style="background-color: #dc2626;" onclick="VanillaApp.cerrarSesion()">Abandonar Barco</button>`; 
            const hoyStr = new Date().toISOString().split('T')[0]; const packRecibido = datosFichaje.ultimoPackDiario === hoyStr;
            const controlHTML = `<div class="bg-nautics-mid bg-opacity-50 p-4 rounded-lg mb-6 text-center border border-nautics-primary-blue"><h3 class="text-lg font-semibold mb-4">Control de Operaciones de Flota</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-nautics-dark bg-opacity-50 p-4 rounded-lg flex flex-col justify-center items-center"><p class="text-base font-bold mb-2">ESTADO DE LA FLOTA</p><div class="flex justify-center items-center gap-4"><button id="abrirLocalBtn" class="btn bg-green-600 hover:bg-green-700">Flota Lista (Abrir)</button><button id="cerrarLocalBtn" class="btn bg-red-600 hover:bg-red-700">Flota Inactiva (Cerrar)</button></div><div class="mt-3"><p id="tiempoAbiertoLocal" class="font-mono text-2xl text-nautics-accent-pink">00:00:00</p><div id="ultimoCierreInfo" class="text-xs text-nautics-light mt-1"></div></div></div><div class="bg-nautics-dark bg-opacity-50 p-4 rounded-lg"><p class="text-base font-bold mb-2">REGISTRO DE GUARDIA</p><div class="grid grid-cols-2 gap-2 text-center h-full"><div class="p-1 rounded-lg bg-nautics-mid flex flex-col justify-center"><p class="text-xs text-nautics-light">GUARDIA</p><p id="tiempoSesion" class="font-mono text-lg">${this.formatearTiempo(0)}</p></div><div class="p-1 rounded-lg bg-nautics-mid flex flex-col justify-center"><p class="text-xs text-nautics-light">HOY</p><p id="tiempoHoy" class="font-mono text-lg">${this.formatearTiempo(tiempoHoy)}</p></div><div class="p-1 rounded-lg bg-nautics-mid flex flex-col justify-center"><p class="text-xs text-nautics-light">SEMANA</p><p id="tiempoSemana" class="font-mono text-lg">${this.formatearTiempo(tiempoSemana)}</p></div><div class="p-1 rounded-lg bg-nautics-mid flex flex-col justify-center"><p class="text-xs text-nautics-light">TOTAL</p><p id="tiempoTotal" class="font-mono text-lg">${this.formatearTiempo(tiempoTotal)}</p></div></div></div></div><div class="mt-6 flex justify-center items-center gap-4 border-t border-nautics-mid pt-4"><button class="btn text-lg px-6 py-3" onclick="VanillaApp.fichar('${nombre}')">Iniciar Guardia</button><button class="btn text-lg px-6 py-3" onclick="VanillaApp.desfichar('${nombre}')">Finalizar Guardia</button><button id="packDiarioBtn" class="btn text-base px-4 py-2" style="background-color: ${packRecibido ? 'var(--color-nautics-mid)' : 'var(--color-nautics-secondary-pink)'};" onclick="VanillaApp.darPackDiarioVentas('${nombre}')" ${packRecibido ? 'disabled' : ''}>${packRecibido ? 'Raciones del día recibidas' : 'Raciones Diarias (Venta)'}</button></div></div>`;
            document.getElementById('contenido').innerHTML = `<div class="p-6 bg-nautics-dark bg-opacity-90 rounded-lg max-w-6xl mx-auto shadow-lg"><div class="flex justify-between items-center mb-6 flex-wrap gap-y-4"><h2 class="text-2xl font-bold">Panel de Tripulación: <span class="text-nautics-light capitalize">${nombre}</span></h2><div class="flex items-center gap-2 flex-wrap">${botonesAccionHTML}</div></div>${controlHTML}<h3 class="text-xl font-semibold mb-4 border-t border-nautics-mid pt-6">Gestión de Flota (Barcos)</h3><div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8" id="panel-barcos">${barcosHTML}</div> <h3 class="text-xl font-semibold mb-4 border-t border-nautics-mid pt-6">Registrar Transacciones</h3><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4" id="productosVenta">${productosVentaHTML}</div></div>`;
            
            await this.actualizarControlesLocal();
            this.startBoatsTimer(); 
            if (datosFichaje.fichado) { this.startClockInTimer(datosFichaje.inicio, datosFichaje.hoy, datosFichaje.semana, datosFichaje.total); }
            document.getElementById('abrirLocalBtn').onclick = () => this.abrirLocal(); 
            document.getElementById('cerrarLocalBtn').onclick = () => this.cerrarLocal();
        },

        async mostrarModalAusencias(nombreEmpleado, esJefe = false) {
            this.stopAllTimers();
            await this.cargarTodosLosEmpleados();
            const empleadoData = this.state.empleados.find(emp => emp.id === nombreEmpleado) || {};
            const ausencias = empleadoData.ausencias || [];

            let ausenciasHTML = ausencias.length === 0 
                ? '<p class="text-center text-nautics-light">No hay permisos de ausencia programados.</p>'
                : ausencias.map((ausencia, index) => {
                    const inicio = new Date(ausencia.inicio).toLocaleDateString('es-ES');
                    const fin = new Date(ausencia.fin).toLocaleDateString('es-ES');
                    return `<li class="flex justify-between items-center p-2 bg-nautics-mid rounded">
                                        <span>Del <strong>${inicio}</strong> al <strong>${fin}</strong></span>
                                        <button onclick="VanillaApp.eliminarAusencia('${nombreEmpleado}', ${index}, ${esJefe})" class="btn text-xs py-1" style="background-color:#dc2626">Revocar Permiso</button>
                                    </li>`; 
                }).join('');

            const hoy = new Date().toISOString().split('T')[0];
            const volverBtn = esJefe 
                ? `<button onclick="VanillaApp.verificarAccesoAdmin()" class="btn" style="background-color:var(--color-nautics-mid);">Volver a Flota Principal</button>`
                : `<button onclick="VanillaApp.mostrarPanelEmpleados('${nombreEmpleado}')" class="btn" style="background-color:var(--color-nautics-mid);">Volver a Panel de Tripulación</button>`;

            const modalHTML = `
                <div class="max-w-2xl mx-auto bg-nautics-dark bg-opacity-90 p-8 rounded-lg shadow-lg border-2 border-nautics-primary-blue">
                    <h2 class="text-2xl font-bold mb-2 text-center text-nautics-text">Gestionar Permisos de Ausencia</h2>
                    <p class="text-center text-nautics-light capitalize mb-6">${nombreEmpleado}</p>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 border-b border-nautics-mid pb-2">Permisos Programados</h3>
                        <ul class="space-y-2">${ausenciasHTML}</ul>
                    </div>
                    ${!esJefe ? `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-3 border-b border-nautics-mid pb-2">Solicitar Nueva Ausencia</h3>
                        <div class="mb-4">
                            <label for="ausenciaInicio" class="block mb-2 text-nautics-light">Fecha de Inicio de Ausencia:</label>
                            <input type="date" id="ausenciaInicio" class="w-full px-3 py-2 text-gray-900 rounded bg-nautics-light" min="${hoy}">
                        </div>
                        <div class="mb-4">
                            <label class="block mb-2 text-nautics-light">Fecha de Fin (opcional):</label>
                            <input type="date" id="ausenciaFin" class="w-full px-3 py-2 text-gray-900 rounded bg-nautics-light" min="${hoy}">
                        </div>
                        <button onclick="VanillaApp.solicitarAusencia('${nombreEmpleado}')" class="btn w-full">Confirmar Solicitud</button>
                    </div>` : ''}
                    <div class="flex justify-end mt-6">${volverBtn}</div>
                </div>`;
            document.getElementById('contenido').innerHTML = modalHTML;
        },
        
        async mostrarPanelAdmin() {
            this.stopAllTimers(); 
            if (typeof this.state.unsubscribeBarcos === 'function') { this.state.unsubscribeBarcos(); } 
            this.ajustarPosicionChatbot(false);

            await this.cargarTodosLosEmpleados(); 
            await this.cargarTodosLosFichajes(); 
            await this.cargarTodasLasVentas(); 
            await this.cargarInventarioLog(); 
            await this.cargarLibroNegro(); 
            await this.cargarListaNegra(); 
            await this.cargarClienteVentas(); 

            const dashboardHTML = `<div class="mb-8 p-6 bg-nautics-mid bg-opacity-50 rounded-lg border border-nautics-primary-blue"><h2 class="text-2xl font-bold mb-4">Dashboard de Flota en Tiempo Real</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="font-semibold mb-2 text-nautics-light">Tripulación de Guardia</h3><ul id="dashboard-empleados" class="space-y-1 text-sm"><li>Cargando...</li></ul></div><div><h3 class="font-semibold mb-2 text-nautics-light">Barcos Ocupados</h3><ul id="dashboard-barcos" class="space-y-1 text-sm"><li>Cargando...</li></ul></div></div></div>`; 
            const anunciosHTML = `
                <div class="mb-8 p-6 bg-nautics-mid bg-opacity-50 rounded-lg border border-nautics-primary-blue">
                    <h2 class="text-2xl font-bold mb-4">Emitir Anuncio a la Flota</h2>
                    <textarea id="anuncioTexto" class="w-full p-2 text-gray-900 rounded bg-nautics-light mb-2" rows="3" placeholder="Escribe tu anuncio aquí..."></textarea>
                    <div class="flex items-center justify-between gap-4 flex-wrap">
                        <div class="flex items-center gap-4">
                            <select id="anuncioDuracion" class="px-3 py-2 text-gray-900 rounded bg-nautics-light">
                                <option value="1">1 Hora</option>
                                <option value="2">2 Horas</option>
                                <option value="4">4 Horas</option>
                                <option value="6">6 Horas</option>
                                <option value="8">8 Horas</option>
                                <option value="24">24 Horas</option>
                                <option value="0">Permanente</option>
                            </select>
                            <button onclick="VanillaApp.publicarAnuncio()" class="btn">Emitir</button>
                            <button onclick="VanillaApp.mostrarResultadosEncuesta()" class="btn" style="background-color:var(--color-nautics-secondary-pink);">Ver Votaciones</button>
                        </div>
                        <div class="flex items-center gap-2 text-nautics-light">
                            <input type="checkbox" id="anuncioEsEncuesta" class="h-4 w-4">
                            <label for="anuncioEsEncuesta">Añadir Votación de Flota (Sí/No)</label>
                        </div>
                    </div>
                </div>`;
            
            let tablaEmpleadosHTML = '';
            this.state.empleados.forEach(e => {
                const f = this.state.fichajes[e.id] || {}; 
                const v = this.state.ventas[e.id] || {};
                let vH = 0, vT = 0; 
                if (v.productos) { 
                    for (const p in v.productos) { 
                        vH += v.productos[p].hoy || 0; 
                        vT += v.productos[p].total || 0; 
                    } 
                }
                const enAusencia = this.estaDeAusencia(e);
                const filaClass = enAusencia ? 'text-red-500' : '';
                const directivaBtnStyle = e.directiva ? 'background-color:#16a34a;' : 'background-color:#555;'; 
                const directivaBtn = `<button onclick="VanillaApp.toggleDirectiva('${e.id}')" class="btn text-xs py-1" style="${directivaBtnStyle}" title="Permiso para Convenios">Directiva</button>`;
                const accionesJefeHTML = `<button onclick="VanillaApp.mostrarModalAusencias('${e.id}', true)" class="btn text-xs py-1" style="background-color:var(--color-nautics-secondary-pink);">Ausencias</button><button onclick="VanillaApp.cambiarContrasena('${e.id}')" class="btn text-xs py-1">Contraseña</button><button onclick="VanillaApp.eliminarEmpleado('${e.id}')" class="text-red-500 hover:text-red-400 font-bold text-lg px-2">X</button>${directivaBtn}`; 
                tablaEmpleadosHTML += `<tr class="border-b border-nautics-mid hover:bg-nautics-mid ${filaClass}"><td class="p-3 capitalize">${e.id}</td><td class="p-3 font-mono">${this.formatearTiempo(f.hoy)}</td><td class="p-3 font-mono">${this.formatearTiempo(f.semana)}</td><td class="p-3 font-mono">${this.formatearTiempo(f.total)}</td><td class="p-3 font-mono text-center">${vH}</td><td class="p-3 font-mono text-center">${vT}</td><td class="p-3 text-center flex gap-1 justify-center">${accionesJefeHTML}</td></tr>`; 
            });

            const gestionHTML = `<div class="mb-8 p-6 bg-nautics-mid bg-opacity-50 rounded-lg border border-nautics-primary-blue"><h2 class="text-2xl font-bold mb-4">Gestión de Tripulación</h2><div class="flex flex-col md:flex-row gap-4"><input type="text" id="newEmployeeName" class="flex-grow px-3 py-2 text-gray-900 rounded bg-nautics-light" placeholder="Nombre y Apellido del nuevo tripulante..."><input type="password" id="newEmployeePass" class="flex-grow px-3 py-2 text-gray-900 rounded bg-nautics-light" placeholder="Contraseña de acceso..."><button onclick="VanillaApp.anadirEmpleado()" class="btn">Añadir Tripulante</button></div></div>`;
            const tablaHTML = `<div class="overflow-x-auto bg-nautics-dark bg-opacity-80 rounded-lg shadow-xl border border-nautics-primary-blue"><table class="w-full text-left text-nautics-text"><thead class="bg-nautics-mid text-nautics-light uppercase text-sm"><tr><th class="p-3">Tripulante</th><th class="p-3">Hoy</th><th class="p-3">Semana</th><th class="p-3">Total</th><th class="p-3 text-center">Trans. Hoy</th><th class="p-3 text-center">Trans. Total</th><th class="p-3 text-center">Acciones de Mando</th></tr></thead><tbody>${tablaEmpleadosHTML}</tbody></table></div>`;
            const libroNegroHTML = `<div class="mb-8 p-6 bg-nautics-mid bg-opacity-50 rounded-lg border border-nautics-primary-blue"><h2 class="text-2xl font-bold mb-4">Bitácora de Contactos Clave</h2><div class="flex flex-col md:flex-row gap-4 mb-4"><input type="text" id="libroNombre" class="flex-grow px-3 py-2 text-gray-900 rounded bg-nautics-light" placeholder="Nombre del contacto..."><select id="libroRelacion" class="px-3 py-2 text-gray-900 rounded bg-nautics-light"><option value="Aliado">Aliado</option><option value="Rival">Rival</option><option value="Neutral">Neutral</option></select><input type="text" id="libroNotas" class="flex-grow px-3 py-2 text-gray-900 rounded bg-nautics-light" placeholder="Notas..."><button onclick="VanillaApp.anadirAlLibroNegro()" class="btn">Registrar</button></div><ul id="listaLibroNegro" class="space-y-2 text-nautics-light"></ul></div>`;
            const listaNegraHTML = `<div class="mb-8 p-6 bg-nautics-mid bg-opacity-50 rounded-lg border border-nautics-primary-blue"><h2 class="text-2xl font-bold mb-4">Lista de Piratas Vetados</h2><div class="flex flex-col md:flex-row gap-4 mb-4"><input type="text" id="vetadoNombre" class="flex-grow px-3 py-2 text-gray-900 rounded bg-nautics-light" placeholder="Nombre del pirata..."><input type="text" id="vetadoMotivo" class="flex-grow px-3 py-2 text-gray-900 rounded bg-nautics-light" placeholder="Motivo del veto..."><button onclick="VanillaApp.anadirAListaNegra()" class="btn" style="background-color: var(--color-nautics-secondary-pink);">Vetar</button></div><ul id="listaDeVetados" class="space-y-2 text-nautics-light"></ul></div>`;
            const inventarioLogHTML = `<div class="mb-8 p-6 bg-nautics-mid bg-opacity-50 rounded-lg border border-nautics-primary-blue"><h2 class="text-2xl font-bold mb-4">Registro de Provisión de Flota</h2><div class="text-center mb-4"><button class="btn" onclick="VanillaApp.toggleInventarioLog()">Mostrar/Ocultar Bitácora</button></div><ul id="listaInventarioLog" class="space-y-4 text-nautics-light" style="display: none;"></ul></div>`;
            
            const informesHTML = `
                <div class="mb-8 p-6 bg-nautics-mid bg-opacity-50 rounded-lg border border-nautics-primary-blue">
                    <h2 class="text-2xl font-bold mb-4">Informes Generales de Mando</h2>
                    <div class="flex justify-center">
                        <button onclick="VanillaApp.descargarInformeExcel()" class="btn text-lg py-3 px-6" style="background-color: #166534;">Descargar Informe (Excel)</button>
                    </div>
                </div>`;

            document.getElementById('contenido').innerHTML = `<div class="max-w-7xl mx-auto"><h1 class="text-4xl font-bold text-center mb-8">Panel de Jefes de Flota</h1>${dashboardHTML}${anunciosHTML}${gestionHTML}${tablaHTML}${informesHTML}${libroNegroHTML}${listaNegraHTML}${inventarioLogHTML}<div class="text-center mt-8"><button onclick="VanillaApp.cerrarSesion()" class="btn">Regresar a Puerto Base</button></div></div>`;
            this.actualizarLibroNegro(); this.actualizarListaNegra(); this.actualizarInventarioLog();
            this.startDashboardTimer(); 
        },
        
        async actualizarDashboard() {
            try {
                await this.cargarTodosLosEmpleados();
                await this.cargarTodosLosFichajes(); 

                const empleadosElem = document.getElementById('dashboard-empleados');
                const barcosElem = document.getElementById('dashboard-barcos'); 
                if (empleadosElem) {
                    const empleadosFichados = Object.entries(this.state.fichajes).filter(([_, data]) => data.fichado).map(([id, data]) => ({ id, ...data }));
                    if (empleadosFichados.length > 0) {
                        empleadosElem.innerHTML = empleadosFichados.map(e => `<li class="capitalize text-green-400">${e.id} (Desde: ${new Date(e.inicio).toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'})})</li>`).join('');
                    } else {
                        empleadosElem.innerHTML = '<li class="text-nautics-light">Nadie de guardia.</li>';
                    }
                }
                if (barcosElem) { 
                    const barcosOcupados = this.state.barcos.filter(h => this.getEstadoBarco(h).estado === 'ocupada'); 
                    if (barcosOcupados.length > 0) {
                        barcosElem.innerHTML = barcosOcupados.map(h => {
                            const estado = this.getEstadoBarco(h); 
                            const finReserva = new Date(estado.reservaActual.fin.toMillis ? estado.reservaActual.fin.toMillis() : estado.reservaActual.fin).toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'});
                            return `<li class="text-nautics-accent-pink">${h.nombre} - Alquilado por: <span class="capitalize">${estado.reservaActual.cliente}</span> (hasta ${finReserva})</li>`; 
                        }).join('');
                    } else {
                        barcosElem.innerHTML = '<li class="text-nautics-light">Ningún barco alquilado.</li>';
                    }
                }
            } catch(e) { console.error("Error actualizando el dashboard:", e); }
        },
        async verificarAccesoAdmin() { 
            const adminPass = document.getElementById('adminPassInput')?.value;

            if (!adminPass) {
                alert("La contraseña de jefes es requerida.");
                return;
            }

            try {
                const adminPassDoc = await Firebase.getDoc(Firebase.doc(db, 'configuracion', 'admin_pass'));
                
                if (adminPassDoc.exists() && this.hashPassword(adminPass) === adminPassDoc.data().passHash) {
                    sessionStorage.setItem('currentUser', "admin-maestro"); 
                    
                    await this.cargarTodosLosEmpleados(); 
                    await this.cargarTodosLosFichajes(); 
                    await this.cargarTodasLasVentas(); 
                    await this.cargarInventarioLog(); 
                    await this.cargarLibroNegro(); 
                    await this.cargarListaNegra(); 
                    await this.cargarClienteVentas(); 
                    this.mostrarPanelAdmin(); 
                } else {
                    alert('Contraseña de jefe incorrecta.');
                }
            } catch (error) {
                console.error("Error en el acceso de jefe:", error);
                alert(`Error de acceso para jefes: ${error.message}. Asegúrate de que el documento 'configuracion/admin_pass' exista en Firestore.`);
            }
        }, 
        async verificarAccesoVIP() { 
            const nombre = document.getElementById('nombreInput')?.value.trim().toLowerCase(); 
            const pass = document.getElementById('passInput')?.value; 
            
            if (!nombre || !pass) {
                alert("Nombre y contraseña son requeridos.");
                return;
            }
            
            try { 
                await this.cargarTodosLosEmpleados(); 
                const empleado = this.state.empleados.find(e => e.id === nombre);

                if (empleado) { 
                    if (this.hashPassword(pass) === empleado.passHash) { 
                        sessionStorage.setItem('currentUser', nombre); 
                        await this.mostrarPanelEmpleados(nombre); 
                    } else { 
                        alert('Contraseña incorrecta.'); 
                    } 
                } else { 
                    alert('Nombre de tripulante no encontrado.'); 
                } 
            } catch(error) { 
                console.error("Error en el acceso VIP:", error); 
                alert(`Error al iniciar sesión: ${error.message}.`); 
            } 
        },
        cerrarSesion() { 
            this.stopAllTimers(); 
            if (typeof this.state.unsubscribeBarcos === 'function') { this.state.unsubscribeBarcos(); } 
            sessionStorage.removeItem('currentUser'); 
            this.mostrarInicio(); 
        },
        async gestionarReseteoDatos(nombre, esVenta = false) { 
            const ahora = new Date(), hoyStr = ahora.toISOString().split('T')[0], semanaNum = this.getWeekNumber(ahora);
            if (esVenta) {
                let datosVentaDoc = await Firebase.getDoc(Firebase.doc(db, 'ventas', nombre)); 
                let datosV = datosVentaDoc.exists() ? datosVentaDoc.data() : { productos: {}, fecha: '' };
                if (!datosV.productos) datosV.productos = {};
                if (datosV.fecha !== hoyStr) {
                    datosV.fecha = hoyStr;
                    Object.keys(datosV.productos).forEach(k => { datosV.productos[k].hoy = 0; });
                }
                this.state.ventas[nombre] = datosV; 
                return datosV;
            } else {
                let datosFichajeDoc = await Firebase.getDoc(Firebase.doc(db, 'fichajes', nombre)); 
                let datosF = datosFichajeDoc.exists() ? datosFichajeDoc.data() : { total: 0, hoy: 0, semana: 0, fecha: hoyStr, numSemana: semanaNum, fichado: false, inicio: null };
                if (datosF.fecha !== hoyStr) {
                    datosF.hoy = 0;
                    datosF.fecha = hoyStr;
                    datosF.ultimoPackDiario = null;
                }
                if (datosF.numSemana !== semanaNum) {
                    datosF.semana = 0;
                    datosF.numSemana = semanaNum;
                }
                this.state.fichajes[nombre] = datosF; 
                return datosF;
            }
        },
        async fichar(nombre) { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { 
                alert("No hay un usuario en sesión. Por favor, inicia sesión.");
                return;
            }

            let d = await this.gestionarReseteoDatos(nombre); 
            if (!d.fichado) { 
                d.fichado = true; d.inicio = Date.now(); this.state.fichajes[nombre] = d; 
                try { 
                    await Firebase.setDoc(Firebase.doc(db, 'fichajes', nombre), d, { merge: true }); 
                    await this.mostrarPanelEmpleados(nombre); 
                } catch (e) { 
                    console.error("Error al fichar:", e); 
                    alert("Error al fichar: " + e.message); 
                } 
            } else {
                alert("Ya estás de guardia."); 
            }
        },
        async desfichar(nombre, silent = false) { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { 
                if (!silent) alert("No hay un usuario en sesión. Por favor, inicia sesión.");
                return;
            }

            this.stopPanelTimers(); 
            let d = await this.gestionarReseteoDatos(nombre); 
            if (d.fichado) { 
                const t = Date.now() - d.inicio; 
                d.hoy = (d.hoy || 0) + t; d.semana = (d.semana || 0) + t; d.total = (d.total || 0) + t; 
                d.fichado = false; d.inicio = null; this.state.fichajes[nombre] = d; 
                try { 
                    await Firebase.setDoc(Firebase.doc(db, 'fichajes', nombre), d, { merge: true }); 
                    if (!silent) await this.mostrarPanelEmpleados(nombre); 
                } catch (e) { 
                    console.error("Error al desfichar:", e); 
                    alert("Error al desfichar: " + e.message); 
                } 
            } else if (!silent) {
                alert("No estás de guardia para desfichar."); 
            }
        },
        
        async solicitarAusencia(nombreEmpleado) { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { alert("No hay usuario en sesión."); return; }

            const inicioStr = document.getElementById('ausenciaInicio').value; const finStr = document.getElementById('ausenciaFin').value;
            if (!inicioStr) return alert('Debes seleccionar una fecha de inicio.');
            const inicio = new Date(inicioStr + 'T00:00:00Z'); const fin = new Date((finStr || inicioStr) + 'T23:59:59Z');
            if (inicio > fin) return alert('La fecha de fin no puede ser anterior a la de inicio.');
            const nuevoPeriodo = { inicio: inicio.getTime(), fin: fin.getTime() };
            const empleadoRef = Firebase.doc(db, 'empleados', nombreEmpleado); 
            try {
                const empleadoDoc = await Firebase.getDoc(empleadoRef);
                const ausenciasActuales = (empleadoDoc.exists() && Array.isArray(empleadoDoc.data().ausencias)) ? empleadoDoc.data().ausencias : [];
                ausenciasActuales.push(nuevoPeriodo);
                await Firebase.updateDoc(empleadoRef, { ausencias: ausenciasActuales });
                alert('Permiso de ausencia registrado.'); this.mostrarModalAusencias(nombreEmpleado); 
            } catch (e) { console.error("Error:", e); alert('Hubo un error al registrar el permiso de ausencia: ' + e.message); }
        },
        async eliminarAusencia(nombreEmpleado, index, esJefe) { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { alert("No hay usuario en sesión."); return; }

            if (!confirm('¿Seguro?')) return;
            const empleadoRef = Firebase.doc(db, 'empleados', nombreEmpleado); 
            try {
                const empleadoDoc = await Firebase.getDoc(empleadoRef);
                const ausenciasActuales = (empleadoDoc.exists() && Array.isArray(empleadoDoc.data().ausencias)) ? empleadoDoc.data().ausencias : [];
                if(index >= 0 && index < ausenciasActuales.length) {
                    ausenciasActuales.splice(index, 1);
                    await Firebase.updateDoc(empleadoRef, { ausencias: ausenciasActuales });
                    alert('Permiso de ausencia revocado.'); this.mostrarModalAusencias(nombreEmpleado, esJefe); 
                }
            } catch(e) { console.error("Error:", e); alert('Hubo un error al revocar el permiso de ausencia: ' + e.message); }
        },
        async modificarVenta(productoId, nombreEmpleado, cantidad) { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { alert("No hay usuario en sesión."); return; }

            const cantNum = parseInt(cantidad); if (isNaN(cantNum)) return;
            let datosVenta = await this.gestionarReseteoDatos(nombreEmpleado, true); 
            const producto = this.state.productos.find(p => p.id === productoId);
            const precioProducto = producto ? producto.precio : 50; 

            if (!datosVenta.productos[productoId]) datosVenta.productos[productoId] = { hoy: 0, total: 0 };
            if (datosVenta.productos[productoId].hoy + cantNum < 0) return;
            datosVenta.productos[productoId].hoy += cantNum;
            datosVenta.productos[productoId].total += cantNum;
            datosVenta.productos[productoId].valorHoy = (datosVenta.productos[productoId].valorHoy || 0) + (cantNum * precioProducto); 
            datosVenta.productos[productoId].valorTotal = (datosVenta.productos[productoId].valorTotal || 0) + (cantNum * precioProducto); 
            this.state.ventas[nombreEmpleado] = datosVenta; 
            try {
                await Firebase.setDoc(Firebase.doc(db, 'ventas', nombreEmpleado), datosVenta); 
                if(document.getElementById('productosVenta')) {
                    const descElem = document.getElementById(`desc-${productoId}`);
                    const totalHoyElem = document.getElementById(`ventas-hoy-${productoId}`);
                    if(descElem) descElem.textContent = `Hoy: ${datosVenta.productos[productoId].hoy} | Total: ${datosVenta.productos[productoId].total}`;
                    if(totalHoyElem) totalHoyElem.textContent = datosVenta.productos[productoId].hoy;
                }
            } catch (e) { console.error("Error al modificar venta:", e); alert("Error al modificar venta: " + e.message); }
        },
        async darPackDiarioVentas(nombre) { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { alert("No hay usuario en sesión."); return; }

            const hoyStr = new Date().toISOString().split('T')[0]; 
            const fichajeRef = Firebase.doc(db, 'fichajes', nombre); 
            try { 
                const fichajeDoc = await Firebase.getDoc(fichajeRef); 
                if (fichajeDoc.exists() && fichajeDoc.data().ultimoPackDiario === hoyStr) { 
                    alert('Ya has recibido las raciones del día.'); 
                    return; 
                } 
                await this.modificarVenta('golosinas_picantes', nombre, 5); 
                await this.modificarVenta('refresco_manzana', nombre, 5); 
                await Firebase.updateDoc(fichajeRef, { ultimoPackDiario: hoyStr }); 
                const packBtn = document.getElementById('packDiarioBtn'); 
                if(packBtn){ packBtn.disabled = true; packBtn.textContent = 'Raciones del día recibidas'; packBtn.style.backgroundColor = 'var(--color-nautics-mid)'; } 
            } catch(e) { console.error("Error al dar pack diario:", e); alert("Error al dar pack diario: " + e.message); }
        },
        async ocuparBarcoAhora(id, nombreEmpleado, durationMinutes) { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { alert("No hay usuario en sesión."); return; }

            console.log(`Intentando alquilar barco ${id} por ${durationMinutes} minutos:`, nombreEmpleado); 
            const boat = this.state.barcos.find(h => h.id === id); 
            if (boat && this.getEstadoBarco(boat).estado === 'disponible') { 
                const ahora = Date.now(); 
                boat.reservas.push({ id: ahora, cliente: nombreEmpleado, inicio: ahora, fin: ahora + durationMinutes * 60 * 1000 }); 
                try { 
                    await Firebase.setDoc(Firebase.doc(db, 'barcos', String(boat.id)), boat); 
                } catch (e) { 
                    console.error("Error al alquilar barco:", e); 
                    alert("Error al alquilar barco: " + e.message); 
                } 
            } else {
                alert("El barco no está disponible para alquiler.");
            }
        }, 
        async anadirTiempoBarco(id, nombreEmpleado, addMinutes) { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { alert("No hay usuario en sesión."); return; }
            
            console.log(`Intentando añadir ${addMinutes} minutos al barco:`, id); 
            const boat = this.state.barcos.find(h => h.id === id); 
            const r = boat.reservas.find(res => Date.now() >= (res.inicio.toMillis ? res.inicio.toMillis() : res.inicio) && Date.now() < (res.fin.toMillis ? res.fin.toMillis() : res.fin)); 
            if (boat && r) { 
                r.fin = (r.fin.toMillis ? r.fin.toMillis() : r.fin) + addMinutes * 60 * 1000; 
                try { 
                    await Firebase.setDoc(Firebase.doc(db, 'barcos', String(boat.id)), boat); 
                } catch (e) { 
                    console.error("Error al añadir tiempo:", e); 
                    alert("Error al añadir tiempo al barco: " + e.message); 
                } 
            } else {
                alert("No hay un alquiler activo para añadir tiempo.");
            }
        }, 
        async liberarBarco(id, nombreEmpleado) { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { alert("No hay usuario en sesión."); return; }
            
            console.log("Intentando liberar barco:", id); 
            const boat = this.state.barcos.find(h => h.id === id); 
            const index = boat.reservas.findIndex(r => Date.now() >= (r.inicio.toMillis ? r.inicio.toMillis() : r.inicio) && Date.now() < (r.fin.toMillis ? r.fin.toMillis() : r.fin)); 
            if (index > -1) { 
                if(confirm(`¿Liberar barco?`)) { 
                    boat.reservas.splice(index, 1); 
                    try { 
                        await Firebase.setDoc(Firebase.doc(db, 'barcos', String(boat.id)), boat); 
                    } catch (e) { 
                        console.error("Error al liberar barco:", e); 
                        alert("Error al liberar barco: " + e.message); 
                    } 
                } 
            } else {
                alert("No hay un barco ocupado para liberar.");
            }
        }, 
        async reservarBarco(id) { 
            const cliente = document.getElementById(`cliente-boat-${id}`).value.trim();
            const fecha = document.getElementById(`fecha-boat-${id}`).value;
            const hora = document.getElementById(`hora-boat-${id}`).value;
            const duracionMinutes = parseInt(document.getElementById(`duracion-boat-${id}`).value); 
            
            if (!cliente || !fecha || !hora || isNaN(duracionMinutes)) {
                return alert('Rellena todos los campos para el alquiler.'); 
            }
            
            const inicio = new Date(`${fecha}T${hora}`); 
            const fin = new Date(inicio.getTime() + duracionMinutes * 60 * 1000); 
            const boat = this.state.barcos.find(h => h.id === id); 
            
            if(boat.reservas.some(r => inicio < (r.fin.toMillis ? r.fin.toMillis() : r.fin) && fin > (r.inicio.toMillis ? r.inicio.toMillis() : r.inicio))) { 
                return alert('Conflicto de horario. Este barco ya está reservado en ese periodo.'); 
            }
            
            boat.reservas.push({id: Date.now(), cliente, inicio: inicio.getTime(), fin: fin.getTime()}); 
            try { 
                await Firebase.setDoc(Firebase.doc(db,'barcos', String(id)), boat); 
                alert('Alquiler confirmado'); 
                this.mostrarPanelBarcos(); 
            } catch(e) {
                console.error("Error al reservar barco:", e);
                alert("Error al reservar barco: " + e.message);
            } 
        }, 
        async anadirEmpleado() { 
            const nombreInput = document.getElementById('newEmployeeName'); 
            const passInput = document.getElementById('newEmployeePass'); 
            const nombre = nombreInput.value.trim().toLowerCase(); 
            const pass = passInput.value; 
            
            if (!nombre || !pass) { 
                return alert('El nombre y la contraseña del tripulante son obligatorios.'); 
            } 
            try { 
                await Firebase.setDoc(Firebase.doc(db, 'empleados', nombre), { 
                    nombre: nombre, 
                    passHash: this.hashPassword(pass), 
                    directiva: false, 
                    ausencias: [] 
                }); 
                alert(`Tripulante ${nombre} añadido correctamente.`); 
                
                nombreInput.value = ''; 
                passInput.value = ''; 
                await this.cargarTodosLosEmpleados(); 
                await this.mostrarPanelAdmin(); 
            } catch (error) {
                console.error("Error al añadir empleado:", error);
                alert(`Error al añadir el tripulante: ${error.message}.`);
            }
        },
        async toggleDirectiva(empleadoNombre) { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; }
            
            const empleadoRef = Firebase.doc(db, 'empleados', empleadoNombre); 
            try { 
                const empleadoDoc = await Firebase.getDoc(empleadoRef); 
                if (empleadoDoc.exists()) { 
                    const currentStatus = empleadoDoc.data().directiva || false; 
                    await Firebase.updateDoc(empleadoRef, { directiva: !currentStatus }); 
                    await this.cargarTodosLosEmpleados(); 
                    await this.mostrarPanelAdmin(); 
                } 
            } catch (e) { console.error("Error al cambiar directiva:", e); alert("Error al cambiar permiso de directiva: " + e.message); }
        },
        async cambiarContrasena(nombre) { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; }

            const nuevaPass = prompt(`Introduce la nueva contraseña para ${nombre}:`); 
            if (nuevaPass) { 
                try { 
                    await Firebase.updateDoc(Firebase.doc(db, 'empleados', nombre), { passHash: this.hashPassword(nuevaPass) }); 
                    alert(`Contraseña (hash) de ${nombre} actualizada.`); 
                }  catch (e) { console.error("Error al cambiar contraseña:", e); alert("Error al cambiar contraseña: " + e.message); } 
            } 
        },
        async eliminarEmpleado(nombre) { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; }

            if (confirm(`¿Estás SEGURO de que quieres eliminar a ${nombre} de la tripulación? Esta acción es irreversible.`)) { 
                try { 
                    await Firebase.deleteDoc(Firebase.doc(db, 'empleados', nombre)); 
                    await Firebase.deleteDoc(Firebase.doc(db, 'fichajes', nombre)); 
                    await Firebase.deleteDoc(Firebase.doc(db, 'ventas', nombre)); 
                    alert(`${nombre} ha sido eliminado de la tripulación.`); 
                    await this.cargarTodosLosEmpleados(); 
                    await this.cargarTodosLosFichajes(); 
                    await this.cargarTodasLasVentas(); 
                    await this.mostrarPanelAdmin(); 
                } catch (e) { console.error("Error al eliminar empleado:", e); alert("Error al eliminar el tripulante: " + e.message); } 
            } 
        },
        async actualizarControlesLocal() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { return; }

            const abrirBtn = document.getElementById('abrirLocalBtn'); 
            const cerrarBtn = document.getElementById('cerrarLocalBtn'); 
            const tiempoElem = document.getElementById('tiempoAbiertoLocal'); 
            const ultimoCierreInfo = document.getElementById('ultimoCierreInfo'); 
            if (!abrirBtn) return; 
            try { 
                const docSnap = await Firebase.getDoc(Firebase.doc(db, "control_local", "estado")); 
                if (docSnap.exists()) { 
                    const estado = docSnap.data(); 
                    if (estado.abierto) { 
                        abrirBtn.disabled = true; 
                        cerrarBtn.disabled = false; 
                        this.startLocalOpenTimer(estado.inicioApertura.toMillis()); 
                        ultimoCierreInfo.innerHTML = ''; 
                    } else { 
                        abrirBtn.disabled = false; 
                        cerrarBtn.disabled = true; 
                        if(this.state.timers.localOpen) clearInterval(this.state.timers.localOpen); 
                        this.state.timers.localOpen = null; 
                        tiempoElem.textContent = "00:00:00"; 
                        let infoHTML = ''; 
                        if (estado.ultimoCierre) { infoHTML += `<div>Último cierre: ${estado.ultimoCierre.toDate().toLocaleString('es-ES')}</div>`; } 
                        if (estado.duracionUltimaApertura) { infoHTML += `<div class="mt-1">Duración: ${this.formatearTiempoHorasDecimal(estado.duracionUltimaApertura)} horas</div>`; } 
                        ultimoCierreInfo.innerHTML = infoHTML; 
                    } 
                } else { 
                    abrirBtn.disabled = false; 
                    cerrarBtn.disabled = true; 
                } 
            } catch (e) { console.error("Error al actualizar controles local:", e); alert("Error al actualizar controles de local: " + e.message); } 
        },
        async abrirLocal() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            try { 
                await Firebase.setDoc(Firebase.doc(db, "control_local", "estado"), { abierto: true, inicioApertura: Firebase.serverTimestamp(), }, { merge: true }); 
                await this.actualizarControlesLocal(); 
            } catch (e) { console.error("Error al abrir local:", e); alert("Error al abrir la flota: " + e.message); }
        },
        async cerrarLocal() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            try { 
                const controlDoc = await Firebase.getDoc(Firebase.doc(db, "control_local", "estado")); 
                let duracion = 0; 
                if (controlDoc.exists() && controlDoc.data().inicioApertura) { duracion = Date.now() - controlDoc.data().inicioApertura.toMillis(); } 
                await this.cargarTodosLosFichajes(); 
                for (const nombreEmpleado in this.state.fichajes) { 
                    if (this.state.fichajes[nombreEmpleado].fichado) { 
                        await this.desfichar(nombreEmpleado, true); 
                    } 
                } 
                await Firebase.setDoc(Firebase.doc(db, "control_local", "estado"), { abierto: false, ultimoCierre: Firebase.serverTimestamp(), duracionUltimaApertura: duracion }, { merge: true }); 
                await this.actualizarControlesLocal(); 
            } catch (e) { console.error("Error al cerrar local:", e); alert("Error al cerrar la flota: " + e.message); }
        },
        async mostrarPanelInventario() { 
            this.stopAllTimers(); this.ajustarPosicionChatbot(false); 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { alert("No hay usuario en sesión."); return; }
            
            this.state.inventoryFiles = [null, null, null]; let uploadBoxesHTML = ''; for (let i = 0; i < 3; i++) { uploadBoxesHTML += `<div id="inventory-box-${i}" class="inventory-upload-box" tabindex="0"><span class="placeholder-text text-nautics-light text-center">Haz clic aquí y pega una imagen con<br/><strong>Ctrl+V</strong></span><img id="inventory-img-${i}" class="hidden"></div>`; } document.getElementById('contenido').innerHTML = `<div class="max-w-4xl mx-auto p-6 bg-nautics-dark bg-opacity-90 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold">Inventario de Provisión</h2><button class="btn" onclick="VanillaApp.mostrarPanelEmpleados('${currentUser}')">Volver al Panel de Tripulación</button></div><div class="bg-nautics-mid p-6 rounded-lg text-center"><h3 class="text-xl font-semibold mb-4">Añadir Nuevo Inventario (hasta 3 imágenes)</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">${uploadBoxesHTML}</div><button id="upload-inventory-btn" class="btn text-lg py-2 px-6" style="background-color: var(--color-nautics-secondary-pink);">Guardar Inventario</button><div id="upload-status" class="mt-4 text-nautics-accent-pink"></div></div></div>`; for (let i = 0; i < 3; i++) { const box = document.getElementById(`inventory-box-${i}`); const img = document.getElementById(`inventory-img-${i}`); const handleFile = (file) => { if (file && file.type.startsWith('image/')) { this.state.inventoryFiles[i] = file; img.src = URL.createObjectURL(file); img.classList.remove('hidden'); box.classList.add('has-image'); }}; box.addEventListener('paste', e => { e.preventDefault(); handleFile(e.clipboardData.files[0]); }); } document.getElementById('upload-inventory-btn').onclick = () => this.subirInventario(); 
        },
        async subirInventario() { 
            const currentUser = sessionStorage.getItem('currentUser'); 
            if (!currentUser) { alert("No hay usuario en sesión."); return; }
            const filesToUpload = this.state.inventoryFiles.filter(f => f !== null); 
            const statusElem = document.getElementById('upload-status'); 
            const uploadBtn = document.getElementById('upload-inventory-btn'); 
            if (filesToUpload.length === 0 || !currentUser) { statusElem.textContent = "Añade al menos una imagen."; return; } 
            statusElem.textContent = `Subiendo ${filesToUpload.length} imagen(es)...`; uploadBtn.disabled = true; try { const uploadPromises = filesToUpload.map(file => { const filePath = `inventario/${Date.now()}_${file.name}`; const storageRef = Firebase.ref(storage, filePath); return Firebase.uploadBytes(storageRef, file).then(snapshot => Firebase.getDownloadURL(snapshot.ref)); }); const imageUrls = await Promise.all(uploadPromises); const datosInventario = { imagenes: imageUrls, subidoPor: currentUser, timestamp: Firebase.serverTimestamp() }; await Firebase.setDoc(Firebase.doc(db, "inventario_actual", "estado"), datosInventario); await Firebase.addDoc(Firebase.collection(db, "inventario_log"), datosInventario); statusElem.textContent = "¡Inventario guardado!"; setTimeout(() => { if (document.getElementById('upload-status')) this.mostrarPanelInventario(); }, 2000); } catch (e) { console.error("Error al subir inventario:", e); statusElem.textContent = "Error al subir: " + e.message; uploadBtn.disabled = false; } 
        },
        toggleInventarioLog() { const lista = document.getElementById('listaInventarioLog'); if (lista) { lista.style.display = lista.style.display === 'none' ? 'block' : 'none'; } },
        mostrarImagenAmpliada(imageUrl) { const overlay = document.getElementById('image-overlay'); const overlayImage = document.getElementById('overlay-image'); if(overlay && overlayImage) { overlayImage.src = imageUrl; overlay.style.display = 'flex'; }},
        async mostrarPanelConvenios(esDirectiva) { 
            this.stopAllTimers(); 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; }
            
            const adminControls = esDirectiva ? `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold">Gestión de Acuerdos Navales</h2><div><button class="btn" style="background-color: #dc2626;" onclick="VanillaApp.setTodosConveniosRojo()">Marcar Todos como Hostiles</button><button class="btn" onclick="VanillaApp.mostrarPanelEmpleados('${currentUser}')">Volver a Panel de Tripulación</button></div></div><div class="bg-nautics-mid p-4 rounded-lg mb-6 flex flex-col md:flex-row gap-4"><input id="convenioNombreInput" class="flex-grow px-3 py-2 text-gray-900 rounded bg-nautics-light" placeholder="Nombre del nuevo acuerdo naval"/><button onclick="VanillaApp.crearConvenio()" class="btn" style="background-color: var(--color-nautics-secondary-pink);">Establecer Nuevo Acuerdo</button></div>` : `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold">Acuerdos Navales</h2><button class="btn" onclick="VanillaApp.mostrarPanelEmpleados('${currentUser}')">Volver a Panel de Tripulación</button></div>`; document.getElementById('contenido').innerHTML = `<div class="max-w-7xl mx-auto p-6 bg-nautics-dark bg-opacity-90 rounded-lg shadow-lg">${adminControls}<div id="contenedorConvenios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>`; await this.cargarConvenios(esDirectiva); 
        },
        async cargarConvenios(esDirectiva) { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { return; } 
            const contenedor = document.getElementById('contenedorConvenios'); if (!contenedor) return; contenedor.innerHTML = ''; try { const q = await Firebase.getDocs(Firebase.query(Firebase.collection(db, 'convenios'), Firebase.orderBy('nombre'))); q.forEach(docu => { const c = { id: docu.id, ...docu.data() }; const p = document.createElement('div'); p.className = "bg-nautics-mid p-4 rounded-lg shadow-md flex flex-col"; let panelControls = ''; if (esDirectiva) { panelControls = `<div class="flex justify-between items-center mb-3"><h3 class="text-xl font-semibold mb-0 capitalize">${c.nombre}</h3><div class="flex gap-2"><div class="status-indicator bg-green-500 ${c.status === 'green' ? 'active' : ''}" onclick="VanillaApp.setConvenioStatus('${c.id}', 'green')"></div><div class="status-indicator bg-red-500 ${c.status === 'red' ? 'active' : ''}" onclick="VanillaApp.setConvenioStatus('${c.id}', 'red')"></div></div></div><div class="flex-grow mb-4 bg-nautics-dark bg-opacity-20 rounded min-h-[200px] flex items-center justify-center">${c.imagenURL ? `<img src="${c.imagenURL}" class="panel-image rounded cursor-pointer" onclick="VanillaApp.mostrarImagenAmpliada('${c.imagenURL}')"/>` : '<span></span>'}</div><label class="btn text-xs py-1 text-center cursor-pointer" style="background-color: var(--color-nautics-secondary-pink);">Subir/Cambiar Imagen<input type="file" class="hidden" accept="image/*" onchange="VanillaApp.subirImagenConvenio('${c.id}', this.files[0])"></label><button onclick="VanillaApp.eliminarConvenio('${c.id}')" class="btn text-xs py-1 mt-2" style="background-color:#dc2626">Romper Acuerdo</button>`; } else { panelControls = `<h3 class="text-xl font-semibold mb-3 capitalize">${c.nombre}</h3><div class="flex-grow mb-4 bg-nautics-dark bg-opacity-20 rounded min-h-[200px] flex items-center justify-center">${c.imagenURL ? `<img src="${c.imagenURL}" class="panel-image rounded cursor-pointer" onclick="VanillaApp.mostrarImagenAmpliada('${c.imagenURL}')"/>` : '<span></span>'}</div>`; } p.innerHTML = panelControls; contenedor.appendChild(p); }); } catch (e) { console.error("Error al cargar convenios:", e); } 
        },
        async crearConvenio() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            const i = document.getElementById('convenioNombreInput'); const n = i.value.trim(); if (!n) return; try { await Firebase.addDoc(Firebase.collection(db, 'convenios'), { nombre: n, imagenURL: null, imagenPath: null, status: 'neutral' }); i.value = ''; await this.cargarConvenios(true); } catch (e) { console.error("Error al crear convenio:", e); alert("Error al crear acuerdo naval: " + e.message); } 
        },
        async eliminarConvenio(id) { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            if (confirm("¿Seguro que quieres romper este acuerdo?")) { try { const d = await Firebase.getDoc(Firebase.doc(db, 'convenios', id)); if (d.exists() && d.data().imagenPath) { await Firebase.deleteObject(Firebase.ref(storage, d.data().imagenPath)); } await Firebase.deleteDoc(Firebase.doc(db, 'convenios', id)); await this.cargarConvenios(true); } catch (e) { console.error("Error al eliminar convenio:", e); alert("Error al romper acuerdo naval: " + e.message); } } 
        },
        async setConvenioStatus(convenioId, newStatus) { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            try { await Firebase.updateDoc(Firebase.doc(db, 'convenios', convenioId), { status: newStatus }); await this.cargarConvenios(true); } catch (e) { console.error("Error al establecer status de convenio:", e); alert("Error al establecer estado de acuerdo: " + e.message); }
        },
        async setTodosConveniosRojo() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            if (!confirm("¿Marcar TODOS los acuerdos como hostiles (rojo)?")) return; const batch = Firebase.writeBatch(db); try { const conveniosSnapshot = await Firebase.getDocs(Firebase.collection(db, 'convenios')); conveniosSnapshot.forEach(doc => { batch.update(doc.ref, { status: 'red' }); }); await batch.commit(); await this.cargarConvenios(true); alert("Acuerdos actualizados a hostiles."); } catch (e) { console.error("Error al establecer todos los convenios a rojo:", e); alert("Error al marcar acuerdos como hostiles: " + e.message); } 
        },
        async subirImagenConvenio(id, file) { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            if (!file) return; const p = `convenios/${id}/${file.name}`; const s = Firebase.ref(storage, p); try { const docSnap = await Firebase.getDoc(Firebase.doc(db, 'convenios', id)); if (docSnap.exists() && docSnap.data().imagenPath) { await Firebase.deleteObject(Firebase.ref(storage, docSnap.data().imagenPath)); } await Firebase.uploadBytes(s, file); const url = await Firebase.getDownloadURL(s); await Firebase.updateDoc(Firebase.doc(db, 'convenios', id), { imagenURL: url, imagenPath: p }); if (document.getElementById('contenedorConvenios')) this.cargarConvenios(true); } catch (e) { console.error("Error al subir imagen convenio:", e); alert("Error al subir imagen de acuerdo: " + e.message); } 
        },
        async mostrarListaNegraPublica() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            await this.cargarListaNegra(); let msg = "--- LISTA NEGRA DE PIRATAS ---\n\n"; this.state.listaNegra.length === 0 ? msg += "Nadie vetado de los mares." : this.state.listaNegra.forEach(p => { msg += `- ${p.nombre} (Motivo: ${p.motivo})\n`; }); alert(msg); 
        },
        async actualizarLibroNegro() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { return; } 
            await this.cargarLibroNegro(); const l = document.getElementById('listaLibroNegro'); if (!l) return; l.innerHTML = ''; this.state.libroNegro.forEach(c => { l.innerHTML += `<li class="flex justify-between items-center p-2 bg-nautics-mid rounded"><span><strong class="capitalize">${c.nombre}</strong> (${c.relacion}) - ${c.notas}</span><button onclick="VanillaApp.eliminarDelLibro('${c.docId}')" class="text-red-500 font-bold px-2">X</button></li>`; }); 
        },
        async anadirAlLibroNegro() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            const n = document.getElementById('libroNombre').value.trim(), r = document.getElementById('libroRelacion').value, o = document.getElementById('libroNotas').value.trim(); if (n) { try { const newDoc = await Firebase.addDoc(Firebase.collection(db, 'libroNegro'), { nombre: n, relacion: r, notas: o }); this.state.libroNegro.push({ docId: newDoc.id, nombre: n, relacion: r, notas: o }); this.actualizarLibroNegro(); document.getElementById('libroNombre').value = ''; document.getElementById('libroNotas').value = ''; } catch(e) { console.error("Error al añadir al libro negro:", e); alert("Error al añadir a la bitácora: " + e.message); } } 
        },
        async eliminarDelLibro(docId) { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            try { await Firebase.deleteDoc(Firebase.doc(db, 'libroNegro', docId)); this.state.libroNegro = this.state.libroNegro.filter(c => c.docId !== docId); this.actualizarLibroNegro(); } catch(e) { console.error("Error al eliminar del libro negro:", e); alert("Error al eliminar de la bitácora: " + e.message); } 
        },
        async actualizarListaNegra() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { return; } 
            await this.cargarListaNegra(); const l = document.getElementById('listaDeVetados'); if (!l) return; l.innerHTML = ''; this.state.listaNegra.forEach(p => { l.innerHTML += `<li class="flex justify-between items-center p-2 bg-red-900 bg-opacity-50 rounded"><span><strong class="capitalize">${p.nombre}</strong> - ${p.motivo}</span><button onclick="VanillaApp.eliminarDeListaNegra('${p.docId}')" class="text-white font-bold px-2">X</button></li>`; }); 
        },
        async anadirAListaNegra() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            const n = document.getElementById('vetadoNombre').value.trim(), m = document.getElementById('vetadoMotivo').value.trim(); if (n && m) { try { const newDoc = await Firebase.addDoc(Firebase.collection(db, 'listaNegra'), { nombre: n, motivo: m }); this.state.listaNegra.push({ docId: newDoc.id, nombre: n, motivo: m }); this.actualizarListaNegra(); document.getElementById('vetadoNombre').value = ''; document.getElementById('vetadoMotivo').value = ''; } catch(e) { console.error("Error al añadir a lista negra:", e); alert("Error al vetar pirata: " + e.message); } } 
        },
        async eliminarDeListaNegra(docId) { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 
            try { await Firebase.deleteDoc(Firebase.doc(db, 'listaNegra', docId)); this.state.listaNegra = this.state.listaNegra.filter(p => p.docId !== docId); this.actualizarListaNegra(); } catch(e) { console.error("Error al eliminar de lista negra:", e); alert("Error al desvetar pirata: " + e.message); } 
        },
        async actualizarInventarioLog() { 
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { return; } 
            await this.cargarInventarioLog(); const contenedor = document.getElementById('listaInventarioLog'); if (!contenedor) return; contenedor.innerHTML = ''; if (this.state.inventarioLog.length === 0) { contenedor.innerHTML = '<li>No hay registros de inventario de flota.</li>'; return; } this.state.inventarioLog.forEach(log => { const fecha = log.timestamp.toDate().toLocaleString('es-ES'); const imgsHTML = log.imagenes ? log.imagenes.map(url => `<img src="${url}" class="w-24 h-24 object-cover rounded cursor-pointer" onclick="VanillaApp.mostrarImagenAmpliada('${url}')" />`).join('') : ''; contenedor.innerHTML += `<li class="flex items-start gap-4 p-3 bg-nautics-mid rounded"><div class="flex gap-2 flex-wrap">${imgsHTML}</div><div><p>Subido por: <strong class="capitalize">${log.subidoPor}</strong></p><p>Fecha: <strong class="font-mono">${fecha}</strong></p></div></li>`; }); 
        },
        toggleInventarioLog() { const lista = document.getElementById('listaInventarioLog'); if (lista) { lista.style.display = lista.style.display === 'none' ? 'block' : 'none'; } },
        
        addMessageToChat(content, sender) {
            const container = document.getElementById('chatbot-messages');
            if (!container) return;
            const msgElem = document.createElement('div');
            msgElem.classList.add('chat-message', `${sender}-message`);
            msgElem.innerHTML = content;
            container.appendChild(msgElem);
            container.scrollTop = container.scrollHeight;
            return msgElem;
        },
        async handleSendMessage() {
            const chatbotInput = document.getElementById('chatbot-input');
            let messageText = chatbotInput.value.trim(); 
            const files = this.state.chatFiles;
            const currentUser = sessionStorage.getItem('currentUser'); 

            if (!messageText && files.length === 0) return; 

            let messageHTML = messageText ? `<p>${messageText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>` : '';
            chatbotInput.value = '';

            if (files.length > 0) {
                const tempId = `msg-${Date.now()}`;
                let previewHTML = messageHTML;
                files.forEach(file => {
                    previewHTML += `<img src="${URL.createObjectURL(file)}" alt="Cargando..." style="opacity: 0.5; max-width: 100%; border-radius: 10px; margin-top: 5px;">`;
                });
                const tempMessage = this.addMessageToChat(previewHTML, 'user');
                tempMessage.id = tempId;

                try {
                    const uploadPromises = files.map(file => {
                        const filePath = `chat_uploads/${Date.now()}_${file.name}`;
                        const storageRef = Firebase.ref(storage, filePath);
                        return Firebase.uploadBytes(storageRef, file).then(snapshot => Firebase.getDownloadURL(snapshot.ref));
                    });
                    const imageUrls = await Promise.all(uploadPromises);
                    
                    let finalHTML = messageText ? `<p>${messageText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>` : '';
                    imageUrls.forEach(url => {
                        finalHTML += `<img src="${url}" alt="Imagen subida" class="chat-message-image cursor-pointer" onclick="VanillaApp.mostrarImagenAmpliada('${url}')">`;
                    });
                    document.getElementById(tempId).innerHTML = finalHTML;
                } catch (e) {
                    console.error("Error subiendo imágenes al chat:", e);
                    document.getElementById(tempId).innerHTML += "<p class='text-red-400 text-xs'>Error al subir imágenes: " + e.message + "</p>";
                }
            } else {
                this.addMessageToChat(messageHTML, 'user');
            }
            
            this.state.chatFiles = [];
            this.renderChatPreviews();

            setTimeout(async () => {
                let mockReply = "Lo siento, almirante, mi brújula no me indica esa dirección. ¿Puedes ser más específico?"; 
                const normalizedUserMsg = messageText.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
                
                const salesRegex = /(?:vender(?:\s+a)?\s+|comprar\s+|dar\s+)?([a-z\s]+)\s+(\d+)\s*(cebos|cañas)(?:(?:\s+y\s+)(\d+)\s*(cebos|cañas))?/i;
                const match = normalizedUserMsg.match(salesRegex);

                if (match) { 
                    const clientFullName = match[1].trim(); 
                    let item1Quantity = parseInt(match[2]);
                    let item1Type = match[3]; 
                    let item2Quantity = match[4] ? parseInt(match[4]) : 0;
                    let item2Type = match[5]; 
                    
                    if (clientFullName.split(' ').length < 2) { 
                        mockReply = "¡Almirante! Para registrar la venta, necesito el nombre y **apellido** del cliente (dos palabras).";
                    } else if (!currentUser) { 
                        mockReply = "¡Capitán, solo la tripulación autorizada puede registrar ventas! Por favor, inicia sesión.";
                    }
                    else {
                        const clientDocRef = Firebase.doc(db, 'clientesVentas', clientFullName);
                        const clientDoc = await Firebase.getDoc(clientDocRef);
                        const clientData = clientDoc.exists() ? clientDoc.data() : { ultimaCompraCebos: null, compras: [] };
                        
                        const lastCeboPurchaseTimestamp = clientData.ultimaCompraCebos;
                        let hasBoughtCebosToday = false;

                        if (lastCeboPurchaseTimestamp) {
                            let lastPurchaseDate = null;
                            if (typeof lastCeboPurchaseTimestamp.toDate === 'function') {
                                lastPurchaseDate = lastCeboPurchaseTimestamp.toDate();
                            } else {
                                lastPurchaseDate = new Date(lastCeboPurchaseTimestamp);
                            }
                            const todayStart = new Date();
                            todayStart.setHours(0,0,0,0);

                            if (lastPurchaseDate >= todayStart) { 
                                hasBoughtCebosToday = true;
                            }
                        }

                        const salesPromises = [];
                        let responseMessages = [];
                        let actualSalesMade = [];

                        // Process first item
                        if (item1Type.toLowerCase().includes('cebo')) {
                            if (hasBoughtCebosToday) {
                                responseMessages.push(`¡Almirante! ${clientFullName} ya compró ${item1Type} hoy. No podemos venderle más ${item1Type}.`);
                            } else {
                                salesPromises.push(Firebase.setDoc(clientDocRef, {
                                    ultimaCompraCebos: Firebase.serverTimestamp(), 
                                    compras: Firebase.arrayUnion({ 
                                        producto: 'cebo',
                                        cantidad: item1Quantity,
                                        timestamp: Date.now(), 
                                        empleado: currentUser
                                    })
                                }, { merge: true }));
                                actualSalesMade.push(`${item1Quantity} ${item1Type}`);
                                hasBoughtCebosToday = true; 
                            }
                        } else if (item1Type.toLowerCase().includes('caña')) {
                            salesPromises.push(Firebase.setDoc(clientDocRef, {
                                compras: Firebase.arrayUnion({ 
                                    producto: 'cana',
                                    cantidad: item1Quantity,
                                    timestamp: Date.now(), 
                                    empleado: currentUser
                                })
                            }, { merge: true }));
                            actualSalesMade.push(`${item1Quantity} ${item1Type}`);
                        }

                        // Process second item if present
                        if (item2Quantity > 0 && item2Type) {
                            if (item2Type.toLowerCase().includes('cebo')) {
                                if (hasBoughtCebosToday) { 
                                    responseMessages.push(`¡Almirante! ${clientFullName} ya compró ${item2Type} hoy (segunda mención).`); 
                                } else {
                                    salesPromises.push(Firebase.setDoc(clientDocRef, {
                                        ultimaCompraCebos: Firebase.serverTimestamp(), 
                                        compras: Firebase.arrayUnion({ 
                                            producto: 'cebo',
                                            cantidad: item2Quantity,
                                            timestamp: Date.now(), 
                                            empleado: currentUser
                                        })
                                    }, { merge: true }));
                                    actualSalesMade.push(`${item2Quantity} ${item2Type}`);
                                    hasBoughtCebosToday = true; 
                                }
                            } else if (item2Type.toLowerCase().includes('caña')) {
                                salesPromises.push(Firebase.setDoc(clientDocRef, {
                                    compras: Firebase.arrayUnion({ 
                                        producto: 'cana',
                                        cantidad: item2Quantity,
                                        timestamp: Date.now(), 
                                        empleado: currentUser
                                    })
                                }, { merge: true }));
                                actualSalesMade.push(`${item2Quantity} ${item2Type}`);
                            }
                        }

                        try {
                            if (salesPromises.length > 0) {
                                await Promise.all(salesPromises);
                                if (actualSalesMade.length > 0) {
                                    responseMessages.unshift(`¡Venta registrada para ${clientFullName}: ${actualSalesMade.join(' y ')}!`); 
                                } else {
                                    responseMessages.unshift(`¡Operación completada para ${clientFullName}!`);
                                }
                                mockReply = responseMessages.join(" ");
                                this.cargarClienteVentas(); 
                            } else if (responseMessages.length > 0) {
                                mockReply = responseMessages.join(" "); 
                            } else {
                                mockReply = `No se pudo registrar la venta para ${clientFullName}. Por favor, verifica el formato o las condiciones.`;
                            }
                        } catch (e) {
                            console.error("Error al registrar venta de cliente:", e);
                            mockReply = "¡Rayos! No pude registrar la venta. Error: " + e.message;
                        }
                    }
                }
                else { 
                    const keywords = {
                        fichar: ["fichar", "entrar", "inicio", "guardia", "trabajar"],
                        empleado: ["empleado", "tripulacion", "panel", "area", "zona"], 
                        producto: ["producto", "provisiones", "vender", "catalogo", "precios"], 
                        barco: ["barco", "flota", "navio", "submarino", "alquilar"],
                        hola: ["hola", "buenas", "buenos", "ey", "ahoy"]
                    };

                    const userMsgLower = normalizedUserMsg; 

                    if (keywords.fichar.some(k => userMsgLower.includes(k))) {
                        if(currentUser) { 
                            this.fichar(currentUser);
                            mockReply = "¡A la guardia! Registro de inicio de turno completado, capitán.";
                        } else {
                            mockReply = "Necesitas iniciar sesión para poder iniciar guardia, capitán.";
                        }
                    } else if (keywords.empleado.some(k => userMsgLower.includes(k))) {
                        mockReply = "¡Por supuesto, al panel de tripulación al instante, almirante!";
                        if (currentUser) {
                             this.irAPanelEmpleado();
                        } else {
                            mockReply += " Necesitas iniciar sesión primero.";
                        }
                    } else if (keywords.producto.some(k => userMsgLower.includes(k))) {
                        mockReply = "¡Zarpo a revisar nuestras provisiones y equipo, almirante!";
                        this.mostrarPanelProductos();
                    } else if (keywords.barco.some(k => userMsgLower.includes(k))) {
                        mockReply = "¡Nuestra flota te espera! Mostrando los barcos disponibles...";
                    } else if (keywords.hola.some(k => userMsgLower.includes(k))) {
                        mockReply = `¡Ahoy, ${currentUser || 'capitán'}! Soy Jack Sparrow, ¿en qué puedo ayudarte hoy?`;
                    } else if (!messageText && files.length > 0) { 
                        mockReply = "¡Qué buena pinta tienen esas fotos, almirante!";
                    }
                }
                
                this.addMessageToChat(mockReply, 'bot');
            }, 1000);
        },
        handleChatPaste(e) {
            const file = e.clipboardData.files[0];
            if (file && file.type.startsWith('image/')) {
                e.preventDefault();
                if (this.state.chatFiles.length < 3) {
                    this.state.chatFiles.push(file);
                    this.renderChatPreviews();
                } else {
                    alert("Puedes adjuntar un máximo de 3 imágenes.");
                }
            }
        },
        renderChatPreviews() {
            const container = document.getElementById('chatbot-image-previews');
            container.innerHTML = '';
            this.state.chatFiles.forEach((file, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'chat-preview-item';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'chat-preview-img';
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '&times;';
                removeBtn.className = 'chat-preview-remove';
                removeBtn.onclick = () => this.removeChatFile(index);
                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                container.appendChild(previewItem);
            });
        },
        removeChatFile(index) {
            this.state.chatFiles.splice(index, 1);
            this.renderChatPreviews();
        },
        ajustarPosicionChatbot(visible) { const bubble = document.getElementById('chatbot-bubble'); if (bubble) { if (visible) bubble.classList.add('visible'); else bubble.classList.remove('visible'); } },

        async publicarAnuncio() {
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; }
            const texto = document.getElementById('anuncioTexto').value;
            const duracionHoras = parseInt(document.getElementById('anuncioDuracion').value);
            const esEncuesta = document.getElementById('anuncioEsEncuesta').checked;
            if (!texto) return alert("El anuncio no puede estar vacío.");
            
            const ahora = Date.now();
            const expiraEn = duracionHoras === 0 ? ahora + (10 * 365 * 24 * 60 * 60 * 1000) : ahora + (duracionHoras * 60 * 60 * 1000);
            
            const anuncioData = { texto, expiraEn, publicadoEn: ahora, esEncuesta };
            if (esEncuesta) {
                anuncioData.votos = {};
            }

            try {
                const anuncioRef = Firebase.doc(db, "configuracion", "anuncio_global");
                await Firebase.setDoc(anuncioRef, anuncioData);
                alert("Anuncio a la flota emitido con éxito.");
                document.getElementById('anuncioTexto').value = '';
                document.getElementById('anuncioEsEncuesta').checked = false;
            } catch (e) { console.error("Error al emitir anuncio:", e); alert("No se pudo emitir el anuncio a la flota: " + e.message); }
        },
        iniciarListenerAnuncios() {
            const anuncioRef = Firebase.doc(db, "configuracion", "anuncio_global");
            Firebase.onSnapshot(anuncioRef, (doc) => {
                const container = document.getElementById('anuncio-panel-lateral');
                if (doc.exists()) {
                    const anuncio = doc.data();
                    const ahora = Date.now();
                    
                    if (anuncio.expiraEn > ahora) {
                        const currentUser = sessionStorage.getItem('currentUser');
                        let contenidoHTML = `<h3 class="text-xl text-nautics-light border-b-2 border-nautics-mid pb-2 mb-4">Anuncio de la Flota</h3><p class="text-base flex-grow">${anuncio.texto}</p>`;
                        if (anuncio.esEncuesta) {
                            const haVotado = currentUser && anuncio.votos && anuncio.votos[currentUser];
                            contenidoHTML += `
                                <div class="mt-4">
                                    <h4 class="text-md font-semibold mb-2">¿Confirmas la votación?</h4>
                                    <div class="flex justify-between gap-2">
                                        <button class="votacion-btn" onclick="VanillaApp.votarEnAnuncio('si')" ${haVotado ? 'disabled' : ''}>✅ A favor</button>
                                        <button class="votacion-btn" onclick="VanillaApp.votarEnAnuncio('no')" ${haVotado ? 'disabled' : ''}>❌ En contra</button>
                                    </div>
                                </div>
                            `;
                        }
                        container.innerHTML = `${contenidoHTML}<button id="anuncio-cerrar">&times;</button>`;
                        container.classList.add('visible');
                        
                        document.getElementById('anuncio-cerrar').onclick = () => container.classList.remove('visible');

                        if (this.state.ultimoAnuncioMostrado !== anuncio.publicadoEn) {
                            document.getElementById('notification-sound').play().catch(e => console.warn("Interacción del usuario necesaria para reproducir audio."));
                            this.state.ultimoAnuncioMostrado = anuncio.publicadoEn;
                        }
                    } else {
                        container.classList.remove('visible');
                    }
                } else {
                    container.classList.remove('visible');
                }
            });
        },
        async votarEnAnuncio(voto) {
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) return alert("Debes iniciar sesión para poder votar, tripulante.");
            
            const anuncioRef = Firebase.doc(db, "configuracion", "anuncio_global");
            try {
                await Firebase.updateDoc(anuncioRef, {
                    [`votos.${currentUser}`]: voto 
                });
            } catch (e) {
                console.error("Error al registrar el voto:", e);
                alert("No se pudo registrar tu voto: " + e.message);
            }
        },
        async mostrarResultadosEncuesta() {
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) { alert("No hay usuario en sesión."); return; } 

            const anuncioRef = Firebase.doc(db, "configuracion", "anuncio_global");
            const docSnap = await Firebase.getDoc(anuncioRef);

            if (!docSnap.exists() || !docSnap.data().esEncuesta) {
                return alert("No hay ninguna votación de flota activa en este momento.");
            }

            const anuncio = docSnap.data();
            const votos = anuncio.votos || {};
            const votosSi = [];
            const votosNo = [];

            for (const nombreVotante in votos) {
                if (votos[nombreVotante] === 'si') {
                    votosSi.push(nombreVotante);
                } else {
                    votosNo.push(nombreVotante);
                }
            }

            let resultadosHTML = `
                <h3 class="text-xl font-bold mb-4">Resultados de Votación: "${anuncio.texto}"</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-green-400 mb-2">A favor (✅):</h4>
                        <ul class="list-disc list-inside">${votosSi.map(e => `<li class="capitalize">${e}</li>`).join('') || '<li>Nadie ha votado a favor.</li>'}</ul>
                    </div>
                    <div>
                        <h4 class="font-semibold text-red-400 mb-2">En contra (❌):</h4>
                        <ul class="list-disc list-inside">${votosNo.map(e => `<li class="capitalize">${e}</li>`).join('') || '<li>Nadie ha votado en contra.</li>'}</ul>
                    </div>
                </div>
            `;
            
            const overlay = document.getElementById('image-overlay');
            overlay.innerHTML = `<div class="bg-nautics-dark p-8 rounded-lg max-w-2xl w-full relative">${resultadosHTML}<span id="overlay-close-btn-resultados" class="cursor-pointer absolute top-2 right-4 text-2xl">&times;</span></div>`;
            overlay.style.display = 'flex';
            overlay.querySelector('#overlay-close-btn-resultados').onclick = () => {
                overlay.style.display = 'none';
                overlay.innerHTML = '<span id="overlay-close-btn">&times;</span><img id="overlay-image" src="" alt="Imagen ampliada">';
                document.getElementById('overlay-close-btn').onclick = () => document.getElementById('image-overlay').style.display = 'none';
            };
        },

        iniciarListenerBarcos() { 
            const q = Firebase.query(Firebase.collection(db, "barcos"), Firebase.orderBy("id")); 
            Firebase.onSnapshot(q, (snapshot) => { 
                const barcosNuevos = []; 
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const reservasConvertidas = data.reservas ? data.reservas.map(res => ({
                        ...res,
                        inicio: res.inicio && typeof res.inicio.toMillis === 'function' ? res.inicio.toMillis() : res.inicio,
                        fin: res.fin && typeof res.fin.toMillis === 'function' ? res.fin.toMillis() : res.fin
                    })) : [];
                    barcosNuevos.push({ ...data, reservas: reservasConvertidas }); 
                });
                this.state.barcos = barcosNuevos; 

                const panelBarcos = document.getElementById('panel-barcos'); 
                if (panelBarcos) {
                    const currentUser = sessionStorage.getItem('currentUser'); 
                    let barcosHTML = this.state.barcos.map(boat => { 
                        const estadoActual = this.getEstadoBarco(boat); 
                        const imagenHTML = `<img src="${boat.imagen}" alt="${boat.nombre}" class="barco-img mb-4" onerror="this.style.display='none'"/>`; 
                        let controles = (estadoActual.estado === 'disponible') 
                            ? `<div class="flex flex-col gap-2"><button class="btn text-sm py-2 w-full" onclick="VanillaApp.ocuparBarcoAhora(${boat.id}, '${currentUser}')">Paseo (30 min)</button><button class="btn text-sm py-2 w-full" onclick="VanillaApp.ocuparBarcoAhora(${boat.id}, '${currentUser}')" style="background-color: var(--color-nautics-secondary-pink);">Alquiler (45 min)</button></div>` 
                            : `<div class="font-mono text-xl mb-2" id="timer-boat-${boat.id}">--:--:--</div><div class="flex gap-2"><button class="btn text-xs py-1 flex-grow" onclick="VanillaApp.anadirTiempoBarco(${boat.id}, '${currentUser}', 30)">+30 min</button><button class="btn text-xs py-1 flex-grow" style="background-color:#dc2626" onclick="VanillaApp.liberarBarco(${boat.id}, '${currentUser}')">Liberar</button></div>`;
                        return `<div class="bg-nautics-mid p-4 rounded-lg text-center flex flex-col justify-between"><div><p class="font-bold text-lg">${boat.nombre}</p><p class="text-sm ${estadoActual.estado === 'ocupada' ? 'text-red-400' : 'text-green-400'} mb-2">${estadoActual.texto}</p></div><div>${controles}</div></div>`;
                    }).join('');
                    panelBarcos.innerHTML = barcosHTML; 
                }
            }, (error) => {
                console.error("Error al escuchar cambios en barcos:", error);
            });
        },
        async init() {
            this.iniciarListenerAnuncios();
            this.iniciarListenerBarcos(); 
            await this.cargarTodosLosEmpleados();
            await this.cargarTodosLosFichajes();
            await this.cargarTodasLasVentas();
            await this.cargarClienteVentas(); 

            const chatButtonWrapper = document.getElementById('chatbot-button-wrapper');
            const chatContainer = document.getElementById('chatbot-container');
            const closeButton = document.getElementById('chatbot-close');
            const minimizeButton = document.getElementById('chatbot-minimize');
            
            if (chatButtonWrapper) {
                chatButtonWrapper.addEventListener('click', () => {
                    if (chatContainer) chatContainer.style.display = 'flex';
                    chatButtonWrapper.style.display = 'none';
                });
            }
            const closeChat = () => {
                if (chatContainer) chatContainer.style.display = 'none';
                if (chatButtonWrapper) chatButtonWrapper.style.display = 'block';
            };
            if (closeButton) closeButton.addEventListener('click', closeChat);
            if (minimizeButton) minimizeButton.addEventListener('click', closeChat);
            
            const overlayCloseBtn = document.getElementById('overlay-close-btn');
            if (overlayCloseBtn) {
                overlayCloseBtn.addEventListener('click', () => { 
                    const imageOverlay = document.getElementById('image-overlay');
                    if (imageOverlay) imageOverlay.style.display = 'none'; 
                });
            }

            const chatbotSendBtn = document.getElementById('chatbot-send');
            const chatbotInputElem = document.getElementById('chatbot-input');
            const chatbotInputContainer = document.getElementById('chatbot-input-container');

            if (chatbotSendBtn) chatbotSendBtn.addEventListener('click', () => this.handleSendMessage());
            if (chatbotInputElem) chatbotInputElem.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.handleSendMessage(); });
            if (chatbotInputContainer) chatbotInputContainer.addEventListener('paste', (e) => this.handleChatPaste(e));

            this.addMessageToChat('¡Ahoy! Soy Jack Sparrow, tu asistente en Nautics. ¿En qué puedo ayudarte?', 'bot'); 

            const currentUser = sessionStorage.getItem('currentUser');
            if (currentUser) {
                await this.irAPanelEmpleado(); 
            } else {
                this.mostrarInicio(); 
            }

            setInterval(async () => {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                if (currentHour === 0 && currentMinute === 0) { 
                    const clientsSnapshot = await Firebase.getDocs(Firebase.collection(db, 'clientesVentas'));
                    const batch = Firebase.writeBatch(db);
                    clientsSnapshot.forEach(doc => {
                        const clientData = doc.data();
                        const lastCeboPurchaseTimestamp = clientData.ultimaCompraCebos;
                        
                        if (lastCeboPurchaseTimestamp) {
                            let lastPurchaseDate = null;
                            if (typeof lastCeboPurchaseTimestamp.toDate === 'function') {
                                lastPurchaseDate = lastCeboPurchaseTimestamp.toDate();
                            } else {
                                lastPurchaseDate = new Date(lastCeboPurchaseTimestamp);
                            }
                            
                            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            
                            if (lastPurchaseDate < todayStart) { 
                                 batch.update(doc.ref, { ultimaCompraCebos: null }); 
                            }
                        }
                    });
                    try {
                        await batch.commit();
                        this.cargarClienteVentas(); 
                    } catch (e) {
                        console.error("Error al resetear restricciones de cebos:", e);
                    }
                }
            }, 1000 * 60); 
        },

        async descargarInformeExcel() {
            alert("Preparando los informes de la flota. La descarga comenzará en breve.");
            
            await this.cargarTodosLosEmpleados();
            await this.cargarTodosLosFichajes();
            await this.cargarTodasLasVentas();
            await this.cargarInventarioLog();
            await this.cargarClienteVentas(); 

            const wb = XLSX.utils.book_new();

            const datosHorarios = this.state.empleados.map(e => {
                const f = this.state.fichajes[e.id] || { hoy: 0, semana: 0, total: 0 };
                return { Empleado: e.nombre, Horas_Hoy: this.formatearTiempo(f.hoy), Horas_Semana: this.formatearTiempo(f.semana), Horas_Total: this.formatearTiempo(f.total) };
            });
            if (datosHorarios.length > 0) {
                const wsHorarios = XLSX.utils.json_to_sheet(datosHorarios);
                XLSX.utils.book_append_sheet(wb, wsHorarios, "Horarios Tripulación");
            }

            const datosVentas = [];
            for (const empleadoNombre in this.state.ventas) { 
                const empleado = this.state.empleados.find(e => e.id === empleadoNombre);
                const employeeName = empleado ? empleado.nombre : empleadoNombre; 

                for (const productoId in this.state.ventas[empleadoNombre].productos) {
                    const productoInfo = this.state.productos.find(p => p.id === productoId);
                    datosVentas.push({ Empleado: employeeName, Producto: productoInfo ? productoInfo.nombre : productoId, Ventas_Hoy: this.state.ventas[empleadoNombre].productos[productoId].hoy || 0, Ventas_Total: this.state.ventas[empleadoNombre].productos[productoId].total || 0 });
                }
            }
            if (datosVentas.length > 0) {
                const wsVentas = XLSX.utils.json_to_sheet(datosVentas);
                XLSX.utils.book_append_sheet(wb, wsVentas, "Transacciones");
            }

            const datosClienteVentas = [];
            for (const clientName in this.state.clientesVentas) {
                const clientData = this.state.clientesVentas[clientName];
                if (clientData.compras && Array.isArray(clientData.compras)) {
                    clientData.compras.forEach(compra => {
                        datosClienteVentas.push({
                            Cliente: clientName,
                            Producto: compra.producto,
                            Cantidad: compra.cantidad,
                            Fecha_Compra: compra.timestamp ? new Date(compra.timestamp).toLocaleString('es-ES') : 'N/A', 
                            Empleado: compra.empleado || 'N/A'
                        });
                    });
                }
            }
            if (datosClienteVentas.length > 0) {
                const wsClienteVentas = XLSX.utils.json_to_sheet(datosClienteVentas);
                XLSX.utils.book_append_sheet(wb, wsClienteVentas, "Ventas a Clientes");
            }

            const datosAusencias = [];
            this.state.empleados.forEach(e => {
                if (e.ausencias && e.ausencias.length > 0) {
                    e.ausencias.forEach(a => {
                        datosAusencias.push({ Empleado: e.nombre, Inicio_Ausencia: new Date(a.inicio).toLocaleDateString('es-ES'), Fin_Ausencia: new Date(a.fin).toLocaleDateString('es-ES') });
                    });
                }
            });
            if (datosAusencias.length > 0) {
                const wsAusencias = XLSX.utils.json_to_sheet(datosAusencias);
                XLSX.utils.book_append_sheet(wb, wsAusencias, "Permisos de Ausencia");
            }
            
            const datosInventario = this.state.inventarioLog.map(log => ({
                Subido_Por: log.subidoPor,
                Fecha: log.timestamp.toDate().toLocaleString('es-ES'),
                Imagenes: (log.imagenes && Array.isArray(log.imagenes)) ? log.imagenes.map((url, i) => `=HYPERLINK("${url}", "Ver Imagen ${i + 1}")`).join(' | ') : ""
            }));
            if (datosInventario.length > 0) {
                const wsInventario = XLSX.utils.json_to_sheet(datosInventario);
                XLSX.utils.book_append_sheet(wb, wsInventario, "Inventario de Flota");
            }

            const datosReservas = [];
            this.state.barcos.forEach(h => { 
                if (h.reservas && h.reservas.length > 0) {
                    h.reservas.forEach(r => {
                        datosReservas.push({ Barco: h.nombre, Cliente: r.cliente, Inicio_Alquiler: new Date(r.inicio.toMillis ? r.inicio.toMillis() : r.inicio).toLocaleString('es-ES'), Fin_Alquiler: new Date(r.fin.toMillis ? r.fin.toMillis() : r.fin).toLocaleString('es-ES') }); 
                    });
                }
            });
            if (datosReservas.length > 0) {
                const wsReservas = XLSX.utils.json_to_sheet(datosReservas);
                XLSX.utils.book_append_sheet(wb, wsReservas, "Alquileres de Barcos"); 
            }

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Informe_General_Nautics.xlsx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    window.VanillaApp = VanillaApp;
    VanillaApp.init();

});
</script>

</body>
</html>